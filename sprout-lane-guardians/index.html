<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="game-id" content="sprout-lane-guardians"><meta name="game-version" content="0.1.0"><title>Sprout Lane Guardians</title><style>:root{--ink:#27402f;--panel:#fffef8;--line:#b8dcc4;--mint:#a8f0cf;--sky:#a5deff;--pink:#ff96c6;--sun:#ffe38a;--danger:#ff8b8b;--gold:#cb9f28;--silver:#8897a6;--bronze:#9d6c48}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body,html{overscroll-behavior:none}body{margin:0;min-height:100vh;color:var(--ink);background:radial-gradient(circle at 15% 10%,#fffadf 0,transparent 34%),radial-gradient(circle at 84% 18%,#ffeaf6 0,transparent 32%),linear-gradient(180deg,#c9f4ff 0,#f1ffe8 55%,#f7f5df 100%);font-family:"Baloo 2",Nunito,"Trebuchet MS",sans-serif;display:flex;justify-content:center;overflow:hidden;touch-action:none;user-select:none}.app{width:min(100vw,540px);padding:10px;padding-top:calc(14px + env(safe-area-inset-top));padding-bottom:calc(14px + env(safe-area-inset-bottom))}.topbar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto auto;gap:8px;margin-bottom:8px}.pill{border:2px solid var(--line);border-radius:12px;background:#ffffffdb;text-align:center;font-size:13px;font-weight:800;padding:8px 4px}button{border:none;border-radius:12px;padding:10px 10px;font-weight:800;font-size:14px;background:#57bf93;color:#fff;cursor:pointer}#arenaWrap{position:relative;border:3px solid #8ec8a8;border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#99d9ff 0,#f7ffe9 100%);box-shadow:inset 0 -30px 110px rgba(49,80,52,.22);touch-action:none}canvas{width:100%;height:auto;display:block;touch-action:none}.hint{min-height:18px;text-align:center;margin-top:6px;font-size:13px;font-weight:700;opacity:.95}.controls{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}.pad{display:grid;grid-template-columns:1fr 1fr;gap:8px}.btn-big{min-height:56px;font-size:19px;border:2px solid #3f8d6d;background:#66ca9f}.btn-center{min-height:56px;font-size:17px;border:2px solid #3f8d6d;background:#4fb98d}.modal,.overlay{position:fixed;inset:0;background:rgba(24,41,29,.52);display:none;align-items:center;justify-content:center;padding:14px;z-index:12}.modal.show,.overlay.show{display:flex}.panel{width:min(100%,470px);background:var(--panel);border-radius:14px;border:2px solid #cee7d6;padding:14px}.panel h2{margin:0 0 8px;font-size:22px}.row{display:flex;align-items:center;gap:8px}.row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}input[type=text]{flex:1;border:2px solid #d4ebdd;border-radius:10px;padding:8px;font-size:14px;min-width:0}.lb-list{list-style:none;margin:10px 0;padding:0;border:1px solid #e4f0e8;border-radius:10px;max-height:280px;overflow:auto;background:#fdfffd}.lb-item{display:grid;grid-template-columns:34px 1fr auto;gap:8px;padding:7px 10px;border-bottom:1px solid #edf7f0;font-size:14px}.lb-item:last-child{border-bottom:none}.rank-1{color:var(--gold);font-weight:800}.rank-2{color:var(--silver);font-weight:800}.rank-3{color:var(--bronze);font-weight:800}.my-rank{font-size:14px;background:#f4ffec;border:2px solid #c8efb6;border-radius:10px;padding:8px 10px}@media (max-width:420px){.topbar{grid-template-columns:1fr 1fr 1fr auto auto}.pill.small-hide{display:none}}</style></head><body><div class="app"><div class="topbar"><div class="pill">Zone <span id="zoneLabel">1</span>/3</div><div class="pill">Party <span id="party">3</span></div><div class="pill">Purify <span id="purify">12</span></div><div class="pill small-hide">Power <span id="power">36</span></div><button id="topBtn">Top</button> <button id="restartBtn">Restart</button></div><div id="arenaWrap"><canvas id="arena" width="420" height="760" aria-label="game field"></canvas></div><div id="hint" class="hint">Drag/tap lane to dodge and collect. Purify cute troublemakers.</div><div class="controls"><div class="pad"><button id="leftBtn" class="btn-big">◀</button> <button id="rightBtn" class="btn-big">▶</button></div><button id="centerBtn" class="btn-center">CENTER</button></div></div><div id="reviveOverlay" class="overlay"><div class="panel"><h2>Revive once?</h2><p id="reviveText">Use rewarded ad in wrapper to continue from checkpoint.</p><div class="row"><button id="reviveBtn">Revive</button> <button id="skipReviveBtn" style="background:#ca6666">No Thanks</button></div></div></div><div id="gameOverOverlay" class="overlay"><div class="panel"><h2 id="resultTitle">Run Ended</h2><p>Score: <strong id="finalScore">0</strong></p><p>Duration: <strong id="finalTime">0.00s</strong></p><p id="resultDetail">Keep collecting growth items before boss.</p><div class="row"><button id="playAgainBtn">Play Again</button></div></div></div><div id="leaderboardModal" class="modal"><div class="panel"><h2>Global Top 10</h2><div id="latestRun" class="my-rank" style="display:none;margin-bottom:8px"></div><div class="row"><input id="nickInput" maxlength="20" disabled="disabled"> <button id="changeNickBtn">Change</button> <button id="saveNickBtn" style="display:none">Save</button></div><ul id="lbList" class="lb-list"></ul><div id="myRank" class="my-rank">My Rank: -</div><div class="row-end"><button id="closeLbBtn">Close</button></div></div></div><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script><script>!function(){"use strict";const e="sprout-lane-guardians",t=e+":nick",n=e+":best",a=e+":interstitial:last",i=420,l=760,o=[106,210,314],r=2460,s=940,c=[0,820,1640,r],d=[{d:560,left:{label:"+3 PARTY",effect:function(){y.party+=3,w("Party +3","#66ca9f")}},right:{label:"PURIFY x1.4",effect:function(){y.purify*=1.4,w("Purify x1.4","#7cbcff")}}},{d:1180,left:{label:"BAG +30%",effect:function(){y.bagBonus+=.3,w("Bag +30%","#f0b96e")}},right:{label:"PARTY -2",effect:function(){y.party=Math.max(1,y.party-2),w("Party -2","#ff8b8b")}}},{d:1760,left:{label:"CHAIN +1",effect:function(){y.chain+=1,w("Chain +1","#c79cff")}},right:{label:"PURIFY /2",effect:function(){y.purify*=.5,w("Purify /2","#ff8b8b")}}}],f=590,u=3.5,m={jelly:"#ff7fb5",dew:"#7ddfff",seed:"#ffe27a",thorn:"#78a15d",mud:"#9f7a58",wind:"#9cd3ff",enemy:"#7a6ae5"},p={arena:document.getElementById("arena"),zoneLabel:document.getElementById("zoneLabel"),party:document.getElementById("party"),purify:document.getElementById("purify"),power:document.getElementById("power"),hint:document.getElementById("hint"),topBtn:document.getElementById("topBtn"),restartBtn:document.getElementById("restartBtn"),leftBtn:document.getElementById("leftBtn"),rightBtn:document.getElementById("rightBtn"),centerBtn:document.getElementById("centerBtn"),reviveOverlay:document.getElementById("reviveOverlay"),reviveText:document.getElementById("reviveText"),reviveBtn:document.getElementById("reviveBtn"),skipReviveBtn:document.getElementById("skipReviveBtn"),gameOverOverlay:document.getElementById("gameOverOverlay"),resultTitle:document.getElementById("resultTitle"),resultDetail:document.getElementById("resultDetail"),finalScore:document.getElementById("finalScore"),finalTime:document.getElementById("finalTime"),playAgainBtn:document.getElementById("playAgainBtn"),leaderboardModal:document.getElementById("leaderboardModal"),lbList:document.getElementById("lbList"),myRank:document.getElementById("myRank"),latestRun:document.getElementById("latestRun"),nickInput:document.getElementById("nickInput"),changeNickBtn:document.getElementById("changeNickBtn"),saveNickBtn:document.getElementById("saveNickBtn"),closeLbBtn:document.getElementById("closeLbBtn")},h=p.arena.getContext("2d"),y={running:!1,modalOpen:!1,awaitingRevive:!1,reviveUsed:!1,elapsedMs:0,score:0,best:Number(localStorage.getItem(n)||0),distance:0,checkpointDistance:0,lane:1,laneVisual:1,checkpointLane:1,party:3,purify:12,dewBuff:0,bagBonus:0,chain:0,slowTimer:0,hitFlash:0,startedSent:!1,objects:[],gates:[],popups:[],purifiedCount:0,itemScore:0,enemyScore:0,boss:{active:!1,hp:f,timer:0,resolved:!1},lastFrame:0,db:null,uid:null,nick:"",nickKeyLower:"",latestSubmitted:null};function g(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ",t="23456789";return"Sprout"+e[Math.floor(24*Math.random())]+t[Math.floor(8*Math.random())]+t[Math.floor(8*Math.random())]}function v(e,t){const n=JSON.stringify({type:e,payload:t||{}});window.ReactNativeWebView&&"function"==typeof window.ReactNativeWebView.postMessage&&window.ReactNativeWebView.postMessage(n)}function b(){const e=1+y.dewBuff+.08*y.chain;return Math.max(1,y.party*y.purify*e)}function k(e){return e<c[1]?1:e<c[2]?2:3}function w(e,t){y.popups.push({text:e,color:t||"#ffffff",t:0,y:592}),y.popups.length>6&&y.popups.shift()}function M(e){return Math.floor(.72*y.distance)+y.itemScore+y.enemyScore+40*y.purifiedCount+Math.floor(65*y.party)+Math.floor(12*y.purify)+(e||0)}function B(e){y.lane=Math.max(0,Math.min(2,e))}function S(){y.running=!0,y.modalOpen=!1,y.awaitingRevive=!1,y.reviveUsed=!1,y.elapsedMs=0,y.score=0,y.distance=0,y.checkpointDistance=0,y.lane=1,y.laneVisual=1,y.checkpointLane=1,y.party=3,y.purify=12,y.dewBuff=0,y.bagBonus=0,y.chain=0,y.slowTimer=0,y.hitFlash=0,y.purifiedCount=0,y.itemScore=0,y.enemyScore=0,y.startedSent=!1,y.objects=function(){const e=function(){let e=20260222%2147483647;return e<=0&&(e+=2147483646),function(){return e=16807*e%2147483647,(e-1)/2147483646}}(),t=[];for(let n=180;n<2180;n+=65+Math.floor(46*e())){if(d.some(function(e){return Math.abs(e.d-n)<90}))continue;const a=Math.floor(3*e()),i=e();i<.28?t.push({kind:"jelly",lane:a,d:n,taken:!1}):i<.42?t.push({kind:"dew",lane:a,d:n,taken:!1}):i<.54?t.push({kind:"seed",lane:a,d:n,taken:!1}):i<.68?t.push({kind:"enemy",lane:a,d:n,need:40+Math.floor(70*e()),taken:!1}):i<.84?t.push({kind:"thorn",lane:a,d:n,taken:!1}):i<.94?t.push({kind:"mud",lane:a,d:n,taken:!1}):t.push({kind:"wind",lane:a,d:n,taken:!1})}for(let e=0;e<8;e++){const n=230+260*e;t.push({kind:"jelly",lane:e%3,d:n,taken:!1}),t.push({kind:"jelly",lane:(e+1)%3,d:n+26,taken:!1})}return t.sort(function(e,t){return e.d-t.d}),t}(),y.gates=d.map(function(e){return{d:e.d,left:e.left,right:e.right,applied:!1}}),y.popups=[],y.boss.active=!1,y.boss.hp=f,y.boss.timer=0,y.boss.resolved=!1,y.lastFrame=0,p.reviveOverlay.classList.remove("show"),p.gameOverOverlay.classList.remove("show"),p.latestRun.style.display="none",p.hint.textContent="Drag/tap lane to dodge and collect. Purify cute troublemakers.",I(),v("GAME_START",{}),y.startedSent=!0}function I(){p.zoneLabel.textContent=String(k(y.distance)),p.party.textContent=String(Math.max(0,Math.floor(y.party))),p.purify.textContent=String(Math.round(y.purify)),p.power.textContent=String(Math.round(b()))}function E(e){y.reviveUsed?R(!1,e||"Failed to stabilize the forest."):(y.running=!1,y.awaitingRevive=!0,y.modalOpen=!0,p.reviveText.textContent="Revive from checkpoint and recover your sprout team.",p.reviveOverlay.classList.add("show"))}function R(e,t){y.running=!1,y.awaitingRevive=!1,y.modalOpen=!1,p.reviveOverlay.classList.remove("show"),p.gameOverOverlay.classList.add("show");const i=Math.max(1,Math.round(y.elapsedMs)),l=M(e?1400:0);e?(p.resultTitle.textContent="Forest Restored",p.resultDetail.textContent=t||"Boss purified. Sparkles everywhere."):(p.resultTitle.textContent="Run Ended",p.resultDetail.textContent=t||"Collect better gates and avoid thorn hits."),y.score=l,y.latestSubmitted={score:l,durationMs:i},p.finalScore.textContent=String(l),p.finalTime.textContent=(i/1e3).toFixed(2)+"s",p.latestRun.style.display="block",p.latestRun.textContent="Latest run: "+l+" points in "+(i/1e3).toFixed(2)+"s",l>y.best&&(y.best=l,localStorage.setItem(n,String(l))),v("GAME_OVER",{score:l,durationMs:i}),function(){try{const e=Date.now(),t=Number(localStorage.getItem(a)||0);return!(t&&e-t<35e3||(localStorage.setItem(a,String(e)),0))}catch(e){return!1}}()&&v("REQUEST_INTERSTITIAL",{reason:"run_completed"}),A(l,i,!1)}function x(e){e[y.lane<=1?"left":"right"].effect(),e.applied=!0,y.checkpointDistance=e.d+20,y.checkpointLane=y.lane}function P(e){if(e.taken=!0,"jelly"===e.kind){const e=Math.round(4*(1+y.bagBonus));return y.purify+=e,y.itemScore+=55,void w("Jelly +"+e,m.jelly)}if("dew"===e.kind){const e=.07*(1+y.bagBonus);return y.dewBuff=Math.min(.65,y.dewBuff+e),y.itemScore+=70,void w("Dew Buff",m.dew)}if("seed"===e.kind){const e=Math.max(1,Math.round(1+.7*y.bagBonus));return y.party+=e,y.itemScore+=90,void w("Party +"+e,m.seed)}if("thorn"===e.kind)return y.party-=1,y.purify=Math.max(5,y.purify-3),y.hitFlash=.25,void w("Ouch",m.danger);if("mud"===e.kind)return y.slowTimer=Math.max(y.slowTimer,1.4),void w("Sticky",m.mud);if("wind"===e.kind)return 0===y.lane||2===y.lane?y.lane=1:y.lane=Math.random()<.5?0:2,void w("Whoosh",m.wind);if("enemy"===e.kind){b()>=e.need?(y.enemyScore+=3*e.need,y.purifiedCount+=1,y.purify+=1.2,w("Purified!","#cfb8ff")):(y.party-=1,y.purify=Math.max(5,y.purify-4),y.hitFlash=.3,w("Too Weak","#ff9a9a"))}}function L(e){const t=e.d-y.distance;if(t<-30||t>s)return;const n=1-t/s,a=638-560*n,i=o[e.lane]+(o[e.lane]-210)*(1-n)*.18;let l=10+20*n;if("enemy"===e.kind&&(l+=4),h.save(),"jelly"===e.kind)h.fillStyle=m.jelly,h.beginPath(),h.ellipse(i,a,.8*l,l,0,0,2*Math.PI),h.fill();else if("dew"===e.kind)h.fillStyle=m.dew,h.beginPath(),h.arc(i,a,.9*l,0,2*Math.PI),h.fill(),h.fillStyle="#ffffff99",h.beginPath(),h.arc(i-.25*l,a-.2*l,.24*l,0,2*Math.PI),h.fill();else if("seed"===e.kind)h.fillStyle=m.seed,h.beginPath(),h.moveTo(i,a-l),h.lineTo(i+.9*l,a+.6*l),h.lineTo(i-.9*l,a+.6*l),h.closePath(),h.fill();else if("thorn"===e.kind){h.fillStyle=m.thorn;for(let e=0;e<3;e++)h.beginPath(),h.arc(i-.7*l+e*l*.7,a,.55*l,0,2*Math.PI),h.fill()}else"mud"===e.kind?(h.fillStyle=m.mud,h.beginPath(),h.ellipse(i,a+.35*l,1.1*l,.55*l,0,0,2*Math.PI),h.fill()):"wind"===e.kind?(h.strokeStyle=m.wind,h.lineWidth=Math.max(2,.14*l),h.beginPath(),h.arc(i,a,.8*l,.2*Math.PI,1.8*Math.PI),h.stroke()):"enemy"===e.kind&&(h.fillStyle=m.enemy,h.beginPath(),h.arc(i,a,.9*l,0,2*Math.PI),h.fill(),h.fillStyle="#fff",h.beginPath(),h.arc(i-.24*l,a-.12*l,.15*l,0,2*Math.PI),h.arc(i+.24*l,a-.12*l,.15*l,0,2*Math.PI),h.fill());h.restore()}function T(){!function(){h.save(),h.fillStyle="#efffe8",h.fillRect(0,0,i,l);for(let e=0;e<14;e++){const t=(.2*y.distance+80*e)%l;h.fillStyle=e%2==0?"#d9f4d1":"#e8fce0",h.fillRect(0,l-t,i,44)}for(let e=0;e<3;e++)h.strokeStyle=1===e?"#9adab2":"#b8e7c8",h.lineWidth=1===e?4:3,h.beginPath(),h.moveTo(o[e]-28,l),h.lineTo(210+.15*(o[e]-210),86),h.stroke();h.restore()}();for(let e=0;e<y.objects.length;e++){const t=y.objects[e];t.taken||L(t)}!function(){for(let e=0;e<y.gates.length;e++){const t=y.gates[e];if(t.applied)continue;const n=t.d-y.distance;if(n<-60||n>s)continue;const a=1-n/s,i=638-560*a;h.save();const l=108+28*a,r=36+16*a;h.fillStyle="#66ca9f",h.fillRect(o[0]-.5*l,i-.5*r,l,r),h.fillStyle="#ffffff",h.font="700 "+Math.max(10,11+6*a)+"px Baloo 2, Nunito, sans-serif",h.textAlign="center",h.fillText(t.left.label,o[0],i+4),h.fillStyle="#6ea9f2",h.fillRect(o[2]-.5*l,i-.5*r,l,r),h.fillStyle="#ffffff",h.fillText(t.right.label,o[2],i+4),h.restore()}}(),function(){const e=o[0]+(o[2]-o[0])*(y.laneVisual/2),t=638;h.save(),y.hitFlash>0&&(h.globalAlpha=.55+.45*Math.sin(.04*y.elapsedMs)),h.fillStyle="#7adf72",h.beginPath(),h.arc(e,t,32,0,2*Math.PI),h.fill(),h.fillStyle="#fff",h.beginPath(),h.arc(e-10,632,6,0,2*Math.PI),h.arc(e+10,632,6,0,2*Math.PI),h.fill(),h.fillStyle="#2c4a2f",h.beginPath(),h.arc(e-10,632,2.4,0,2*Math.PI),h.arc(e+10,632,2.4,0,2*Math.PI),h.fill(),h.strokeStyle="#2c4a2f",h.lineWidth=3,h.beginPath(),h.arc(e,644,8,.2,Math.PI-.2),h.stroke(),h.fillStyle="#93ec80",h.beginPath(),h.ellipse(e-8,603,8,14,-.5,0,2*Math.PI),h.ellipse(e+8,603,8,14,.5,0,2*Math.PI),h.fill(),h.restore()}(),function(){if(!y.boss.active)return;h.save();const e=210,t=178;h.fillStyle="#cfd4ff",h.beginPath(),h.arc(e,t,74,0,2*Math.PI),h.fill(),h.fillStyle="#fff",h.beginPath(),h.arc(190,168,10,0,2*Math.PI),h.arc(230,168,10,0,2*Math.PI),h.fill(),h.fillStyle="#5a5a8b",h.beginPath(),h.arc(190,168,3.4,0,2*Math.PI),h.arc(230,168,3.4,0,2*Math.PI),h.fill(),h.strokeStyle="#8490d1",h.lineWidth=4,h.beginPath(),h.arc(e,196,18,.2,Math.PI-.2),h.stroke();const n=244,a=Math.max(0,y.boss.hp/f),i=Math.max(0,y.boss.timer/u);h.fillStyle="#ffffffc5",h.fillRect(88,60,n,14),h.fillStyle="#ff95cd",h.fillRect(88,60,n*a,14),h.fillStyle="#ffffffc5",h.fillRect(88,80,n,10),h.fillStyle="#8bc1ff",h.fillRect(88,80,n*i,10),h.fillStyle="#27402f",h.font="700 14px Baloo 2, Nunito, sans-serif",h.textAlign="center",h.fillText("Boss Purify",210,52),h.restore()}(),function(){h.save(),h.textAlign="center",h.font="700 18px Baloo 2, Nunito, sans-serif";for(let e=0;e<y.popups.length;e++){const t=y.popups[e];h.globalAlpha=Math.max(0,1-t.t/.9),h.fillStyle=t.color,h.fillText(t.text,210,t.y-14*e)}h.restore()}(),h.save(),h.fillStyle="#ffffffc9",h.fillRect(8,8,190,58),h.fillStyle="#27402f",h.font="700 14px Baloo 2, Nunito, sans-serif",h.fillText("Dist "+Math.floor(y.distance)+" / "+r,16,28),h.fillText("Score "+M(0),16,48),h.restore()}async function N(a){const i=y.db;if(!i||!y.uid)throw new Error("auth_not_ready");const l=function(e){return String(e||"").trim().toLowerCase().replace(/\s+/g," ").slice(0,20)}(a);if(l.length<2)throw new Error("nickname_too_short");if(l.length>20)throw new Error("nickname_too_long");const o=y.nickKeyLower;if(o===l)return y.nick=a,void localStorage.setItem(t,a);const r=i.collection("games").doc(e);await i.runTransaction(async function(e){const t=r.collection("nicknames").doc(l),i=await e.get(t);if(i.exists&&i.data().uid!==y.uid)throw new Error("nickname_taken");if(e.set(t,{uid:y.uid,nick:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),o&&o!==l){const t=r.collection("nicknames").doc(o),n=await e.get(t);n.exists&&n.data().uid===y.uid&&e.delete(t)}const s=r.collection("players").doc(y.uid);e.set(s,{uid:y.uid,nick:a,bestRankValue:Number(localStorage.getItem(n)||0),bestRawValue:Number(localStorage.getItem(n)||0),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}),y.nick=a,y.nickKeyLower=l,localStorage.setItem(t,a)}async function A(t,n,a){if(!y.db||!y.uid||!Number.isFinite(t))return;a||y.latestSubmitted&&y.latestSubmitted.score;const i=y.db.collection("games").doc(e),l=i.collection("leaderboard").doc(y.uid),o=i.collection("players").doc(y.uid);await y.db.runTransaction(async function(e){const i=await e.get(l),r=i.exists?Number(i.data().rankValue):null;if(null!==r&&t<r&&!a)return;e.set(l,{uid:y.uid,nick:y.nick,rankValue:t,rawValue:t,durationMs:n,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0});const s=await e.get(o),c=s.exists?Number(s.data().bestRankValue||0):0;e.set(o,{uid:y.uid,nick:y.nick,bestRankValue:Math.max(c,t),bestRawValue:Math.max(c,t),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})})}async function F(){if(!y.db)return p.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Offline</span><strong>-</strong></li>",void(p.myRank.textContent="My Rank: Offline");const t=y.db.collection("games").doc(e).collection("leaderboard"),n=await t.orderBy("rankValue","desc").limit(10).get(),a=[];if(n.forEach(function(e,t){const n=e.data()||{},i=t+1,l=1===i?"rank-1":2===i?"rank-2":3===i?"rank-3":"",o=n.nick||"Anon",r=Number(n.rankValue||0);a.push("<li class='lb-item'><span class='"+l+"'>"+i+"</span><span>"+(String(o||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")+"</span><strong>")+r+"</strong></li>")}),0===a.length&&a.push("<li class='lb-item'><span>-</span><span>No entries yet</span><strong>0</strong></li>"),p.lbList.innerHTML=a.join(""),!y.uid)return void(p.myRank.textContent="My Rank: Sign-in pending");const i=await t.doc(y.uid).get();if(!i.exists)return void(p.myRank.textContent="My Rank: Unranked");const l=Number((i.data()||{}).rankValue||0),o=(await t.where("rankValue",">",l).get()).size+1;p.myRank.textContent="My Rank: #"+o+" | "+y.nick+" | "+l}function O(){y.modalOpen=!1,p.leaderboardModal.classList.remove("show")}function C(e){try{const t="string"==typeof e?JSON.parse(e):e;if(!t||!t.type)return;"REWARDED_GRANTED"===t.type?y.awaitingRevive&&(y.reviveUsed=!0,y.awaitingRevive=!1,y.modalOpen=!1,y.running=!0,y.distance=y.checkpointDistance,y.lane=y.checkpointLane,y.party=Math.max(2,y.party+2),y.purify+=8,y.dewBuff+=.08,y.hitFlash=0,w("Revived!","#fff09c"),p.reviveOverlay.classList.remove("show")):"REWARDED_DENIED"===t.type&&y.awaitingRevive&&R(!1,"Revive was not granted.")}catch(e){}}!function(){function e(e){if(y.modalOpen)return;const t=e.touches&&e.touches[0]?e.touches[0].clientX:e.clientX;null!=t&&B(function(e){const t=p.arena.getBoundingClientRect(),n=(e-t.left)/t.width;return n<.333?0:n>.666?2:1}(t))}p.arena.addEventListener("pointerdown",e,{passive:!0}),p.arena.addEventListener("pointermove",function(t){1===t.buttons&&e(t)},{passive:!0}),p.arena.addEventListener("touchstart",e,{passive:!0}),p.arena.addEventListener("touchmove",e,{passive:!0}),p.leftBtn.addEventListener("pointerdown",function(){B(y.lane-1)}),p.rightBtn.addEventListener("pointerdown",function(){B(y.lane+1)}),p.centerBtn.addEventListener("pointerdown",function(){B(1)}),window.addEventListener("keydown",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||B(y.lane-1),"ArrowRight"!==e.key&&"d"!==e.key||B(y.lane+1),"ArrowDown"!==e.key&&"s"!==e.key||B(1)})}(),p.restartBtn.addEventListener("click",S),p.playAgainBtn.addEventListener("click",S),p.topBtn.addEventListener("click",function(){!async function(){y.modalOpen=!0,p.leaderboardModal.classList.add("show"),y.latestSubmitted&&(p.latestRun.style.display="block"),await F()}()}),p.closeLbBtn.addEventListener("click",O),p.reviveBtn.addEventListener("click",function(){v("REQUEST_REWARDED",{reason:"revive"})}),p.skipReviveBtn.addEventListener("click",function(){R(!1,"Skipped revive.")}),p.changeNickBtn.addEventListener("click",function(){p.nickInput.disabled=!1,p.saveNickBtn.style.display="inline-block",p.changeNickBtn.style.display="none",p.nickInput.focus()}),p.saveNickBtn.addEventListener("click",async function(){const e=(p.nickInput.value||"").trim();if(e.length<2)alert("Nickname must be at least 2 characters.");else try{await N(e),p.nickInput.disabled=!0,p.saveNickBtn.style.display="none",p.changeNickBtn.style.display="inline-block",await F()}catch(e){"nickname_taken"===String(e&&e.message)?alert("Nickname is already taken."):alert("Failed to save nickname.")}}),window.addEventListener("message",function(e){C(e.data)}),document.addEventListener("message",function(e){C(e.data)}),function(){try{const a={apiKey:"<api-key>",authDomain:"<project-id>.firebaseapp.com",projectId:"<project-id>",appId:"<app-id>"};if(!a.projectId||a.projectId.indexOf("<")>=0)throw new Error("firebase_placeholder");firebase.initializeApp(a),y.db=firebase.firestore();return firebase.auth().signInAnonymously().then(function(t){return y.uid=t.user.uid,y.db?y.db.collection("games").doc(e).set({gameId:e,name:"Sprout Lane Guardians",sortDirection:"desc",rankType:"score",updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}):Promise.resolve()}).then(async function(){const e=(localStorage.getItem(t)||"").trim()||g();try{await N(e)}catch(e){const t=g();await N(t)}p.nickInput.value=y.nick,await F();const a=Number(localStorage.getItem(n)||0);a>0&&await A(a,0,!0)}).catch(function(){y.db=null})}catch(e){return y.db=null,Promise.resolve()}}(),S(),requestAnimationFrame(function e(t){y.lastFrame||(y.lastFrame=t);const n=Math.min(.034,(t-y.lastFrame)/1e3);y.lastFrame=t,function(e){if(y.running&&!y.modalOpen){if(y.elapsedMs+=1e3*e,y.hitFlash>0&&(y.hitFlash=Math.max(0,y.hitFlash-e)),y.slowTimer>0&&(y.slowTimer=Math.max(0,y.slowTimer-e)),y.laneVisual+=(y.lane-y.laneVisual)*Math.min(1,14*e),y.boss.active){const t=.66*b();if(y.boss.hp=Math.max(0,y.boss.hp-t*e),y.boss.timer-=e,y.boss.hp<=0&&!y.boss.resolved)return y.boss.resolved=!0,void R(!0,"울보 먹구름왕을 정화했어요.");if(y.boss.timer<=0&&!y.boss.resolved)return y.boss.resolved=!0,void E("Boss purify was not enough.")}else{const t=y.slowTimer>0?.62:1,n=(190+18*k(y.distance))*t;y.distance+=n*e;for(let e=0;e<y.gates.length;e++){const t=y.gates[e];!t.applied&&y.distance>=t.d-6&&x(t)}for(let e=0;e<y.objects.length;e++){const t=y.objects[e];t.taken||Math.abs(t.d-y.distance)>20||Math.abs(t.lane-y.laneVisual)>.45||P(t)}if(y.party<=0)return void E("Your sprout party ran out.");y.distance>=r&&(y.boss.active=!0,y.boss.hp=f,y.boss.timer=u,y.checkpointDistance=2440,y.checkpointLane=y.lane,w("Boss!","#ffd3ec"))}for(let t=y.popups.length-1;t>=0;t--){const n=y.popups[t];n.t+=e,n.y-=26*e,n.t>.9&&y.popups.splice(t,1)}I()}}(n),T(),requestAnimationFrame(e)})}()</script></body></html>