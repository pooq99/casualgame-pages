<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="game-id" content="sprout-lane-guardians"><meta name="game-version" content="0.1.0"><title>Sprout Lane Guardians</title><style>:root{--ink:#27402f;--panel:#fffef8;--line:#b8dcc4;--mint:#a8f0cf;--sky:#a5deff;--pink:#ff96c6;--sun:#ffe38a;--danger:#ff8b8b;--gold:#cb9f28;--silver:#8897a6;--bronze:#9d6c48}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body,html{overscroll-behavior:none}body{margin:0;min-height:100vh;color:var(--ink);background:radial-gradient(circle at 15% 10%,#fffadf 0,transparent 34%),radial-gradient(circle at 84% 18%,#ffeaf6 0,transparent 32%),linear-gradient(180deg,#c9f4ff 0,#f1ffe8 55%,#f7f5df 100%);font-family:"Baloo 2",Nunito,"Trebuchet MS",sans-serif;display:flex;justify-content:center;overflow:hidden;touch-action:none;user-select:none}.app{width:min(100vw,540px);padding:10px;padding-top:calc(14px + env(safe-area-inset-top));padding-bottom:calc(14px + env(safe-area-inset-bottom))}.topbar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto auto;gap:8px;margin-bottom:8px}.pill{border:2px solid var(--line);border-radius:12px;background:#ffffffdb;text-align:center;font-size:13px;font-weight:800;padding:8px 4px}button{border:none;border-radius:12px;padding:10px 10px;font-weight:800;font-size:14px;background:#57bf93;color:#fff;cursor:pointer}#arenaWrap{position:relative;border:3px solid #8ec8a8;border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#99d9ff 0,#f7ffe9 100%);box-shadow:inset 0 -30px 110px rgba(49,80,52,.22);touch-action:none}canvas{width:100%;height:auto;display:block;touch-action:none}.hint{min-height:18px;text-align:center;margin-top:6px;font-size:13px;font-weight:700;opacity:.95}.tutorial-banner{margin-top:6px;min-height:34px;border:2px solid #bde7cb;border-radius:12px;background:#f7fff3;display:none;align-items:center;justify-content:center;text-align:center;padding:6px 10px;font-size:13px;font-weight:800;color:#256047}.tutorial-banner.show{display:flex}.controls{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}.pad{display:grid;grid-template-columns:1fr 1fr;gap:8px}.btn-big{min-height:56px;font-size:19px;border:2px solid #3f8d6d;background:#66ca9f}.btn-center{min-height:56px;font-size:17px;border:2px solid #3f8d6d;background:#4fb98d}.modal,.overlay{position:fixed;inset:0;background:rgba(24,41,29,.52);display:none;align-items:center;justify-content:center;padding:14px;z-index:12}.modal.show,.overlay.show{display:flex}.panel{width:min(100%,470px);background:var(--panel);border-radius:14px;border:2px solid #cee7d6;padding:14px}.panel h2{margin:0 0 8px;font-size:22px}.row{display:flex;align-items:center;gap:8px}.row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}input[type=text]{flex:1;border:2px solid #d4ebdd;border-radius:10px;padding:8px;font-size:14px;min-width:0}.lb-list{list-style:none;margin:10px 0;padding:0;border:1px solid #e4f0e8;border-radius:10px;max-height:280px;overflow:auto;background:#fdfffd}.lb-item{display:grid;grid-template-columns:34px 1fr auto;gap:8px;padding:7px 10px;border-bottom:1px solid #edf7f0;font-size:14px}.lb-item:last-child{border-bottom:none}.rank-1{color:var(--gold);font-weight:800}.rank-2{color:var(--silver);font-weight:800}.rank-3{color:var(--bronze);font-weight:800}.my-rank{font-size:14px;background:#f4ffec;border:2px solid #c8efb6;border-radius:10px;padding:8px 10px}@media (max-width:420px){.topbar{grid-template-columns:1fr 1fr 1fr auto auto}.pill.small-hide{display:none}}</style></head><body><div class="app"><div class="topbar"><div class="pill">Zone <span id="zoneLabel">1</span>/3</div><div class="pill">Party <span id="party">3</span></div><div class="pill">Purify <span id="purify">12</span></div><div class="pill small-hide">Power <span id="power">36</span></div><button id="topBtn">Top</button> <button id="restartBtn">Restart</button></div><div id="arenaWrap"><canvas id="arena" width="420" height="760" aria-label="game field"></canvas></div><div id="hint" class="hint">Drag/tap lane to dodge and collect. Purify cute troublemakers.</div><div id="tutorialBanner" class="tutorial-banner"></div><div class="controls"><div class="pad"><button id="leftBtn" class="btn-big">◀</button> <button id="rightBtn" class="btn-big">▶</button></div><button id="centerBtn" class="btn-center">CENTER</button></div></div><div id="reviveOverlay" class="overlay"><div class="panel"><h2>Revive once?</h2><p id="reviveText">Use rewarded ad in wrapper to continue from checkpoint.</p><div class="row"><button id="reviveBtn">Revive</button> <button id="skipReviveBtn" style="background:#ca6666">No Thanks</button></div></div></div><div id="gameOverOverlay" class="overlay"><div class="panel"><h2 id="resultTitle">Run Ended</h2><p>Score: <strong id="finalScore">0</strong></p><p>Duration: <strong id="finalTime">0.00s</strong></p><p id="resultDetail">Keep collecting growth items before boss.</p><div class="row"><button id="playAgainBtn">Play Again</button></div></div></div><div id="leaderboardModal" class="modal"><div class="panel"><h2>Global Top 10</h2><div id="latestRun" class="my-rank" style="display:none;margin-bottom:8px"></div><div class="row"><input id="nickInput" maxlength="20" disabled="disabled"> <button id="changeNickBtn">Change</button> <button id="saveNickBtn" style="display:none">Save</button></div><ul id="lbList" class="lb-list"></ul><div id="myRank" class="my-rank">My Rank: -</div><div class="row-end"><button id="closeLbBtn">Close</button></div></div></div><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script><script>!function(){"use strict";const e="sprout-lane-guardians",t=e+":nick",n=e+":best",a=e+":interstitial:last",i=e+":tutorialSeen",l=420,o=760,r=[106,210,314],s=2460,c=940,d=[0,820,1640,s],f=[{d:560,left:{label:"+2 PARTY",effect:function(){S.party+=2,R("Party +2","#66ca9f")}},right:{label:"+8 PURIFY",effect:function(){S.purify+=8,R("Purify +8","#7cbcff")}}},{d:1180,left:{label:"+3 PARTY",effect:function(){S.party+=3,R("Party +3","#66ca9f")}},right:{label:"+10 PURIFY",effect:function(){S.purify+=10,R("Purify +10","#7cbcff")}}},{d:1760,left:{label:"+4 PARTY",effect:function(){S.party+=4,R("Party +4","#66ca9f")}},right:{label:"PURIFY x1.5",effect:function(){S.purify*=1.5,R("Purify x1.5","#7cbcff")}}}],u=520,p=520,m=4,h="#ff7fb5",y="#ffe27a",g="#78a15d",v="#ff8b8b",b="#7a6ae5",k={arena:document.getElementById("arena"),zoneLabel:document.getElementById("zoneLabel"),party:document.getElementById("party"),purify:document.getElementById("purify"),power:document.getElementById("power"),hint:document.getElementById("hint"),tutorialBanner:document.getElementById("tutorialBanner"),topBtn:document.getElementById("topBtn"),restartBtn:document.getElementById("restartBtn"),leftBtn:document.getElementById("leftBtn"),rightBtn:document.getElementById("rightBtn"),centerBtn:document.getElementById("centerBtn"),reviveOverlay:document.getElementById("reviveOverlay"),reviveText:document.getElementById("reviveText"),reviveBtn:document.getElementById("reviveBtn"),skipReviveBtn:document.getElementById("skipReviveBtn"),gameOverOverlay:document.getElementById("gameOverOverlay"),resultTitle:document.getElementById("resultTitle"),resultDetail:document.getElementById("resultDetail"),finalScore:document.getElementById("finalScore"),finalTime:document.getElementById("finalTime"),playAgainBtn:document.getElementById("playAgainBtn"),leaderboardModal:document.getElementById("leaderboardModal"),lbList:document.getElementById("lbList"),myRank:document.getElementById("myRank"),latestRun:document.getElementById("latestRun"),nickInput:document.getElementById("nickInput"),changeNickBtn:document.getElementById("changeNickBtn"),saveNickBtn:document.getElementById("saveNickBtn"),closeLbBtn:document.getElementById("closeLbBtn")},M=k.arena.getContext("2d"),S={running:!1,modalOpen:!1,awaitingRevive:!1,reviveUsed:!1,elapsedMs:0,score:0,best:Number(localStorage.getItem(n)||0),distance:0,checkpointDistance:0,lane:1,laneVisual:1,checkpointLane:1,party:3,purify:12,hitFlash:0,startedSent:!1,tutorial:{active:!1,elapsed:0,step:0},objects:[],gates:[],popups:[],purifiedCount:0,itemScore:0,enemyScore:0,boss:{active:!1,hp:p,timer:0,resolved:!1,lastDps:0},lastFrame:0,db:null,uid:null,nick:"",nickKeyLower:"",latestSubmitted:null};function B(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ",t="23456789";return"Sprout"+e[Math.floor(24*Math.random())]+t[Math.floor(8*Math.random())]+t[Math.floor(8*Math.random())]}function I(e,t){const n=JSON.stringify({type:e,payload:t||{}});window.ReactNativeWebView&&"function"==typeof window.ReactNativeWebView.postMessage&&window.ReactNativeWebView.postMessage(n)}function w(){return Math.max(1,S.party*S.purify)}function x(){return Math.max(18,Math.min(40,18+.34*(S.purify-12)))}function E(e){return e<d[1]?1:e<d[2]?2:3}function R(e,t){S.popups.push({text:e,color:t||"#ffffff",t:0,y:592}),S.popups.length>6&&S.popups.shift()}function P(e){return Math.floor(.72*S.distance)+S.itemScore+S.enemyScore+40*S.purifiedCount+Math.floor(65*S.party)+Math.floor(12*S.purify)+(e||0)}function T(e){S.lane=Math.max(0,Math.min(2,e))}function L(){if(!S.tutorial.active)return k.tutorialBanner.classList.remove("show"),void(k.tutorialBanner.textContent="");k.tutorialBanner.classList.add("show"),0===S.tutorial.step?k.tutorialBanner.textContent="Tutorial 1/3: 좌우로 이동해서 젤리를 먹어보세요":1===S.tutorial.step?k.tutorialBanner.textContent="Tutorial 2/3: 씨앗을 먹어 동료 수를 늘리세요":k.tutorialBanner.textContent="Tutorial 3/3: 게이트에서 원하는 강화 쪽 lane으로 지나가세요"}function N(){S.running=!0,S.modalOpen=!1,S.awaitingRevive=!1,S.reviveUsed=!1,S.elapsedMs=0,S.score=0,S.distance=0,S.checkpointDistance=0,S.lane=1,S.laneVisual=1,S.checkpointLane=1,S.party=3,S.purify=12,S.hitFlash=0,S.purifiedCount=0,S.itemScore=0,S.enemyScore=0,S.startedSent=!1,S.tutorial.active="1"!==localStorage.getItem(i),S.tutorial.elapsed=0,S.tutorial.step=0,S.objects=function(){const e=function(){let e=20260222%2147483647;return e<=0&&(e+=2147483646),function(){return e=16807*e%2147483647,(e-1)/2147483646}}(),t=[];for(let n=180;n<2180;n+=65+Math.floor(46*e())){if(f.some(function(e){return Math.abs(e.d-n)<90}))continue;const a=Math.floor(3*e()),i=e();i<.42?t.push({kind:"jelly",lane:a,d:n,taken:!1}):i<.62?t.push({kind:"seed",lane:a,d:n,taken:!1}):i<.82?t.push({kind:"enemy",lane:a,d:n,need:35+Math.floor(55*e()),taken:!1}):t.push({kind:"thorn",lane:a,d:n,taken:!1})}for(let e=0;e<8;e++){const n=230+260*e;t.push({kind:"jelly",lane:e%3,d:n,taken:!1}),t.push({kind:"jelly",lane:(e+1)%3,d:n+26,taken:!1})}if(S.tutorial.active){t.push({kind:"jelly",lane:0,d:170,taken:!1}),t.push({kind:"jelly",lane:1,d:210,taken:!1}),t.push({kind:"seed",lane:2,d:290,taken:!1}),t.push({kind:"seed",lane:1,d:340,taken:!1});for(let e=0;e<t.length;e++)t[e].d<560&&("enemy"===t[e].kind||"thorn"===t[e].kind)&&(t[e].kind=e%2==0?"jelly":"seed")}return t.sort(function(e,t){return e.d-t.d}),t}(),S.gates=f.map(function(e){return{d:e.d,left:e.left,right:e.right,applied:!1}}),S.popups=[],S.boss.active=!1,S.boss.hp=p,S.boss.timer=0,S.boss.resolved=!1,S.boss.lastDps=0,S.lastFrame=0,k.reviveOverlay.classList.remove("show"),k.gameOverOverlay.classList.remove("show"),k.latestRun.style.display="none",k.hint.textContent="1) 젤리/씨앗 먹기 2) 게이트 선택 3) 보스 정화",L(),A(),I("GAME_START",{}),S.startedSent=!0}function A(){const e=Math.round(w()),t=u;k.zoneLabel.textContent=String(E(S.distance)),k.party.textContent=String(Math.max(0,Math.floor(S.party))),k.purify.textContent=String(Math.round(S.purify)),k.power.textContent=String(e),S.tutorial.active?k.hint.textContent="젤리를 먹으면 주인공이 커집니다. 씨앗으로 같은 크기 동료를 늘리세요":S.boss.active?k.hint.textContent="보스전: 자동 정화중 (파워 "+e+" / 권장 "+t+")":k.hint.textContent=e<.55*t?"젤리/씨앗 위주로 먹어 파워를 키우세요":"좋아요! 장애물 피하면서 보스로 이동하세요"}function C(e){S.reviveUsed?F(!1,e||"Failed to stabilize the forest."):(S.running=!1,S.awaitingRevive=!0,S.modalOpen=!0,k.reviveText.textContent="Revive from checkpoint and recover your sprout team.",k.reviveOverlay.classList.add("show"))}function F(e,t){S.running=!1,S.awaitingRevive=!1,S.modalOpen=!1,k.reviveOverlay.classList.remove("show"),k.gameOverOverlay.classList.add("show");const i=Math.max(1,Math.round(S.elapsedMs)),l=P(e?1400:0);e?(k.resultTitle.textContent="Forest Restored",k.resultDetail.textContent=t||"Boss purified. Sparkles everywhere."):(k.resultTitle.textContent="Run Ended",k.resultDetail.textContent=t||"Collect better gates and avoid thorn hits."),S.score=l,S.latestSubmitted={score:l,durationMs:i},k.finalScore.textContent=String(l),k.finalTime.textContent=(i/1e3).toFixed(2)+"s",k.latestRun.style.display="block",k.latestRun.textContent="Latest run: "+l+" points in "+(i/1e3).toFixed(2)+"s",l>S.best&&(S.best=l,localStorage.setItem(n,String(l))),I("GAME_OVER",{score:l,durationMs:i}),function(){try{const e=Date.now(),t=Number(localStorage.getItem(a)||0);return!(t&&e-t<35e3||(localStorage.setItem(a,String(e)),0))}catch(e){return!1}}()&&I("REQUEST_INTERSTITIAL",{reason:"run_completed"}),W(l,i,!1)}function O(e){e[S.lane<=1?"left":"right"].effect(),e.applied=!0,S.checkpointDistance=e.d+20,S.checkpointLane=S.lane}function D(e){if(e.taken=!0,"jelly"===e.kind){const e=5;return S.purify+=e,S.itemScore+=55,void R("Jelly +"+e,h)}if("seed"===e.kind){const e=1;return S.party+=e,S.itemScore+=90,void R("Party +"+e,y)}if("thorn"===e.kind)return S.party-=1,S.purify=Math.max(5,S.purify-3),S.hitFlash=.25,void R("Ouch",v);if("enemy"===e.kind){w()>=e.need?(S.enemyScore+=3*e.need,S.purifiedCount+=1,S.purify+=1.2,R("Purified!","#cfb8ff")):(S.party-=1,S.purify=Math.max(5,S.purify-4),S.hitFlash=.3,R("Too Weak","#ff9a9a"))}}function V(e){const t=e.d-S.distance;if(t<-30||t>c)return;const n=84+560*(1-t/c),a=r[e.lane];let i=18;if("enemy"===e.kind&&(i=22),"thorn"===e.kind&&(i=16),M.save(),"jelly"===e.kind)M.fillStyle=h,M.beginPath(),M.ellipse(a,n,.8*i,i,0,0,2*Math.PI),M.fill();else if("seed"===e.kind)M.fillStyle=y,M.beginPath(),M.moveTo(a,n-i),M.lineTo(a+.9*i,n+.6*i),M.lineTo(a-.9*i,n+.6*i),M.closePath(),M.fill();else if("thorn"===e.kind){M.fillStyle=g;for(let e=0;e<3;e++)M.beginPath(),M.arc(a-.7*i+e*i*.7,n,.55*i,0,2*Math.PI),M.fill()}else"enemy"===e.kind&&(M.fillStyle=b,M.beginPath(),M.arc(a,n,.9*i,0,2*Math.PI),M.fill(),M.fillStyle="#fff",M.beginPath(),M.arc(a-.24*i,n-.12*i,.15*i,0,2*Math.PI),M.arc(a+.24*i,n-.12*i,.15*i,0,2*Math.PI),M.fill());M.restore()}function j(){!function(){M.save(),M.fillStyle="#eaf8ea",M.fillRect(0,0,l,o);const e=108,t=[{x:r[0]-54,color:"#dff5d9"},{x:r[1]-54,color:"#d3f1cb"},{x:r[2]-54,color:"#dff5d9"}];for(let n=0;n<t.length;n++)M.fillStyle=t[n].color,M.fillRect(t[n].x,0,e,o);M.strokeStyle="#b7ddbf",M.lineWidth=3,M.beginPath(),M.moveTo(.5*(r[0]+r[1]),0),M.lineTo(.5*(r[0]+r[1]),o),M.moveTo(.5*(r[1]+r[2]),0),M.lineTo(.5*(r[1]+r[2]),o),M.stroke();for(let e=0;e<10;e++){const t=(.35*S.distance+88*e)%o;M.fillStyle="#ffffff73",M.fillRect(28,t,364,6)}M.restore()}();for(let e=0;e<S.objects.length;e++){const t=S.objects[e];t.taken||V(t)}!function(){for(let e=0;e<S.gates.length;e++){const t=S.gates[e];if(t.applied)continue;const n=t.d-S.distance;if(n<-60||n>c)continue;const a=1-n/c,i=84+560*a;M.save();const l=120,o=46;M.fillStyle="#66ca9f",M.fillRect(r[0]-.5*l,i-.5*o,l,o),M.fillStyle="#ffffff",M.font="700 "+Math.max(10,11+6*a)+"px Baloo 2, Nunito, sans-serif",M.textAlign="center",M.fillText(t.left.label,r[0],i+4),M.fillStyle="#6ea9f2",M.fillRect(r[2]-.5*l,i-.5*o,l,o),M.fillStyle="#ffffff",M.fillText(t.right.label,r[2],i+4),M.restore()}}(),function(){const e=r[0]+(r[2]-r[0])*(S.laneVisual/2),t=638,n=Math.max(0,Math.floor(S.party)-1),a=Math.min(6,n),i=x();M.save(),S.hitFlash>0&&(M.globalAlpha=.55+.45*Math.sin(.04*S.elapsedMs));for(let n=0;n<a;n++){const a=1.2*i*(n%3-1),l=1.55*i+Math.floor(n/3)*(1.1*i),o=i*(1+.03*Math.sin(.006*S.elapsedMs+.8*n));M.fillStyle="#8fdf84",M.beginPath(),M.arc(e+a,t+l,o,0,2*Math.PI),M.fill(),M.fillStyle="#ffffff",M.beginPath(),M.arc(e+a-.33*o,t+l-.18*o,.15*o,0,2*Math.PI),M.arc(e+a+.33*o,t+l-.18*o,.15*o,0,2*Math.PI),M.fill()}n>a&&(M.fillStyle="#2c4a2f",M.font="700 13px Baloo 2, Nunito, sans-serif",M.textAlign="center",M.fillText("+"+(n-a),e,t+3.9*i)),M.fillStyle="#7adf72",M.beginPath(),M.arc(e,t,i,0,2*Math.PI),M.fill(),M.fillStyle="#fff",M.beginPath(),M.arc(e-.3*i,t-.2*i,.2*i,0,2*Math.PI),M.arc(e+.3*i,t-.2*i,.2*i,0,2*Math.PI),M.fill(),M.fillStyle="#2c4a2f",M.beginPath(),M.arc(e-.3*i,t-.2*i,.08*i,0,2*Math.PI),M.arc(e+.3*i,t-.2*i,.08*i,0,2*Math.PI),M.fill(),M.strokeStyle="#2c4a2f",M.lineWidth=3,M.beginPath(),M.arc(e,t+.22*i,.28*i,.2,Math.PI-.2),M.stroke(),M.fillStyle="#93ec80",M.beginPath(),M.ellipse(e-.24*i,t-1.1*i,.24*i,.4*i,-.5,0,2*Math.PI),M.ellipse(e+.24*i,t-1.1*i,.24*i,.4*i,.5,0,2*Math.PI),M.fill(),M.restore()}(),function(){if(!S.boss.active)return;M.save();const e=210,t=178,n=r[0]+(r[2]-r[0])*(S.laneVisual/2),a=x(),i=Math.max(0,Math.floor(S.party)-1),l=Math.min(6,i);M.strokeStyle="#8ae8ff88",M.lineWidth=2.5,M.beginPath(),M.moveTo(n,638-a),M.lineTo(e,206);for(let t=0;t<l;t++){const i=1.2*a*(t%3-1),l=1.55*a+Math.floor(t/3)*(1.1*a);M.moveTo(n+i,638+l-.2*a),M.lineTo(e+4*(t-3.5),208)}M.stroke(),M.fillStyle="#cfd4ff",M.beginPath(),M.arc(e,t,74,0,2*Math.PI),M.fill(),M.fillStyle="#fff",M.beginPath(),M.arc(190,168,10,0,2*Math.PI),M.arc(230,168,10,0,2*Math.PI),M.fill(),M.fillStyle="#5a5a8b",M.beginPath(),M.arc(190,168,3.4,0,2*Math.PI),M.arc(230,168,3.4,0,2*Math.PI),M.fill(),M.strokeStyle="#8490d1",M.lineWidth=4,M.beginPath(),M.arc(e,196,18,.2,Math.PI-.2),M.stroke();const o=244,s=Math.max(0,S.boss.hp/p),c=Math.max(0,S.boss.timer/m);M.fillStyle="#ffffffc5",M.fillRect(88,60,o,14),M.fillStyle="#ff95cd",M.fillRect(88,60,o*s,14),M.fillStyle="#ffffffc5",M.fillRect(88,80,o,10),M.fillStyle="#8bc1ff",M.fillRect(88,80,o*c,10),M.fillStyle="#27402f",M.font="700 14px Baloo 2, Nunito, sans-serif",M.textAlign="center",M.fillText("Boss Purify",210,52),M.font="700 13px Baloo 2, Nunito, sans-serif",M.fillText("정화 진행중  DPS "+Math.round(S.boss.lastDps)+"/s",210,106),M.restore()}(),function(){M.save(),M.textAlign="center",M.font="700 18px Baloo 2, Nunito, sans-serif";for(let e=0;e<S.popups.length;e++){const t=S.popups[e];M.globalAlpha=Math.max(0,1-t.t/.9),M.fillStyle=t.color,M.fillText(t.text,210,t.y-14*e)}M.restore()}(),M.save(),M.fillStyle="#ffffffd9",M.fillRect(8,8,318,78),M.fillStyle="#27402f",M.font="700 14px Baloo 2, Nunito, sans-serif",M.fillText("Dist "+Math.floor(S.distance)+" / "+s,16,28),M.fillText("Score "+P(0),16,48),M.fillText("규칙: 젤리=정화력+, 씨앗=동료+, 가시=동료-1",16,68),M.restore()}async function _(a){const i=S.db;if(!i||!S.uid)throw new Error("auth_not_ready");const l=function(e){return String(e||"").trim().toLowerCase().replace(/\s+/g," ").slice(0,20)}(a);if(l.length<2)throw new Error("nickname_too_short");if(l.length>20)throw new Error("nickname_too_long");const o=S.nickKeyLower;if(o===l)return S.nick=a,void localStorage.setItem(t,a);const r=i.collection("games").doc(e);await i.runTransaction(async function(e){const t=r.collection("nicknames").doc(l),i=await e.get(t);if(i.exists&&i.data().uid!==S.uid)throw new Error("nickname_taken");if(e.set(t,{uid:S.uid,nick:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),o&&o!==l){const t=r.collection("nicknames").doc(o),n=await e.get(t);n.exists&&n.data().uid===S.uid&&e.delete(t)}const s=r.collection("players").doc(S.uid);e.set(s,{uid:S.uid,nick:a,bestRankValue:Number(localStorage.getItem(n)||0),bestRawValue:Number(localStorage.getItem(n)||0),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}),S.nick=a,S.nickKeyLower=l,localStorage.setItem(t,a)}async function W(t,n,a){if(!S.db||!S.uid||!Number.isFinite(t))return;a||S.latestSubmitted&&S.latestSubmitted.score;const i=S.db.collection("games").doc(e),l=i.collection("leaderboard").doc(S.uid),o=i.collection("players").doc(S.uid);await S.db.runTransaction(async function(e){const i=await e.get(l),r=i.exists?Number(i.data().rankValue):null;if(null!==r&&t<r&&!a)return;e.set(l,{uid:S.uid,nick:S.nick,rankValue:t,rawValue:t,durationMs:n,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0});const s=await e.get(o),c=s.exists?Number(s.data().bestRankValue||0):0;e.set(o,{uid:S.uid,nick:S.nick,bestRankValue:Math.max(c,t),bestRawValue:Math.max(c,t),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})})}async function U(){if(!S.db)return k.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Offline</span><strong>-</strong></li>",void(k.myRank.textContent="My Rank: Offline");const t=S.db.collection("games").doc(e).collection("leaderboard"),n=await t.orderBy("rankValue","desc").limit(10).get(),a=[];if(n.forEach(function(e,t){const n=e.data()||{},i=t+1,l=1===i?"rank-1":2===i?"rank-2":3===i?"rank-3":"",o=n.nick||"Anon",r=Number(n.rankValue||0);a.push("<li class='lb-item'><span class='"+l+"'>"+i+"</span><span>"+(String(o||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")+"</span><strong>")+r+"</strong></li>")}),0===a.length&&a.push("<li class='lb-item'><span>-</span><span>No entries yet</span><strong>0</strong></li>"),k.lbList.innerHTML=a.join(""),!S.uid)return void(k.myRank.textContent="My Rank: Sign-in pending");const i=await t.doc(S.uid).get();if(!i.exists)return void(k.myRank.textContent="My Rank: Unranked");const l=Number((i.data()||{}).rankValue||0),o=(await t.where("rankValue",">",l).get()).size+1;k.myRank.textContent="My Rank: #"+o+" | "+S.nick+" | "+l}function Y(){S.modalOpen=!1,k.leaderboardModal.classList.remove("show")}function z(e){try{const t="string"==typeof e?JSON.parse(e):e;if(!t||!t.type)return;"REWARDED_GRANTED"===t.type?S.awaitingRevive&&(S.reviveUsed=!0,S.awaitingRevive=!1,S.modalOpen=!1,S.running=!0,S.distance=S.checkpointDistance,S.lane=S.checkpointLane,S.party=Math.max(2,S.party+2),S.purify+=8,S.hitFlash=0,R("Revived!","#fff09c"),k.reviveOverlay.classList.remove("show")):"REWARDED_DENIED"===t.type&&S.awaitingRevive&&F(!1,"Revive was not granted.")}catch(e){}}!function(){function e(e){if(S.modalOpen)return;const t=e.touches&&e.touches[0]?e.touches[0].clientX:e.clientX;null!=t&&T(function(e){const t=k.arena.getBoundingClientRect(),n=(e-t.left)/t.width;return n<.333?0:n>.666?2:1}(t))}k.arena.addEventListener("pointerdown",e,{passive:!0}),k.arena.addEventListener("pointermove",function(t){1===t.buttons&&e(t)},{passive:!0}),k.arena.addEventListener("touchstart",e,{passive:!0}),k.arena.addEventListener("touchmove",e,{passive:!0}),k.leftBtn.addEventListener("pointerdown",function(){T(S.lane-1)}),k.rightBtn.addEventListener("pointerdown",function(){T(S.lane+1)}),k.centerBtn.addEventListener("pointerdown",function(){T(1)}),window.addEventListener("keydown",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||T(S.lane-1),"ArrowRight"!==e.key&&"d"!==e.key||T(S.lane+1),"ArrowDown"!==e.key&&"s"!==e.key||T(1)})}(),k.restartBtn.addEventListener("click",N),k.playAgainBtn.addEventListener("click",N),k.topBtn.addEventListener("click",function(){!async function(){S.modalOpen=!0,k.leaderboardModal.classList.add("show"),S.latestSubmitted&&(k.latestRun.style.display="block"),await U()}()}),k.closeLbBtn.addEventListener("click",Y),k.reviveBtn.addEventListener("click",function(){I("REQUEST_REWARDED",{reason:"revive"})}),k.skipReviveBtn.addEventListener("click",function(){F(!1,"Skipped revive.")}),k.changeNickBtn.addEventListener("click",function(){k.nickInput.disabled=!1,k.saveNickBtn.style.display="inline-block",k.changeNickBtn.style.display="none",k.nickInput.focus()}),k.saveNickBtn.addEventListener("click",async function(){const e=(k.nickInput.value||"").trim();if(e.length<2)alert("Nickname must be at least 2 characters.");else try{await _(e),k.nickInput.disabled=!0,k.saveNickBtn.style.display="none",k.changeNickBtn.style.display="inline-block",await U()}catch(e){"nickname_taken"===String(e&&e.message)?alert("Nickname is already taken."):alert("Failed to save nickname.")}}),window.addEventListener("message",function(e){z(e.data)}),document.addEventListener("message",function(e){z(e.data)}),function(){try{const a={apiKey:"<api-key>",authDomain:"<project-id>.firebaseapp.com",projectId:"<project-id>",appId:"<app-id>"};if(!a.projectId||a.projectId.indexOf("<")>=0)throw new Error("firebase_placeholder");firebase.initializeApp(a),S.db=firebase.firestore();return firebase.auth().signInAnonymously().then(function(t){return S.uid=t.user.uid,S.db?S.db.collection("games").doc(e).set({gameId:e,name:"Sprout Lane Guardians",sortDirection:"desc",rankType:"score",updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}):Promise.resolve()}).then(async function(){const e=(localStorage.getItem(t)||"").trim()||B();try{await _(e)}catch(e){const t=B();await _(t)}k.nickInput.value=S.nick,await U();const a=Number(localStorage.getItem(n)||0);a>0&&await W(a,0,!0)}).catch(function(){S.db=null})}catch(e){return S.db=null,Promise.resolve()}}(),N(),requestAnimationFrame(function e(t){S.lastFrame||(S.lastFrame=t);const n=Math.min(.034,(t-S.lastFrame)/1e3);S.lastFrame=t,function(e){if(S.running&&!S.modalOpen){if(S.elapsedMs+=1e3*e,S.tutorial.active&&(S.tutorial.elapsed+=e,S.tutorial.elapsed<2.5?S.tutorial.step=0:S.tutorial.elapsed<5?S.tutorial.step=1:S.tutorial.step=2,L(),S.tutorial.elapsed>=8&&(S.tutorial.active=!1,localStorage.setItem(i,"1"),L())),S.hitFlash>0&&(S.hitFlash=Math.max(0,S.hitFlash-e)),S.laneVisual+=(S.lane-S.laneVisual)*Math.min(1,14*e),S.boss.active){const t=.66*w();if(S.boss.lastDps=t,S.boss.hp=Math.max(0,S.boss.hp-t*e),S.boss.timer-=e,S.boss.hp<=0&&!S.boss.resolved)return S.boss.resolved=!0,void F(!0,"울보 먹구름왕을 정화했어요.");if(S.boss.timer<=0&&!S.boss.resolved)return S.boss.resolved=!0,void C("Boss purify was not enough.")}else{const t=196+14*E(S.distance);S.distance+=t*e;for(let e=0;e<S.gates.length;e++){const t=S.gates[e];!t.applied&&S.distance>=t.d-6&&O(t)}for(let e=0;e<S.objects.length;e++){const t=S.objects[e];t.taken||Math.abs(t.d-S.distance)>20||Math.abs(t.lane-S.laneVisual)>.45||D(t)}if(S.party<=0)return void C("Your sprout party ran out.");S.distance>=s&&(S.boss.active=!0,S.boss.hp=p,S.boss.timer=m,S.checkpointDistance=2440,S.checkpointLane=S.lane,R("Boss!","#ffd3ec"))}for(let t=S.popups.length-1;t>=0;t--){const n=S.popups[t];n.t+=e,n.y-=26*e,n.t>.9&&S.popups.splice(t,1)}A()}}(n),j(),requestAnimationFrame(e)})}()</script></body></html>