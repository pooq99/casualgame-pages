<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover"><meta name="app-version" content="0.1"><title>Lane Flip Sprint</title><link rel="icon" href="./favicon.ico"><style>:root{--safe-top:env(safe-area-inset-top, 0px);--safe-bottom:env(safe-area-inset-bottom, 0px);--safe-left:env(safe-area-inset-left, 0px);--safe-right:env(safe-area-inset-right, 0px)}body,html{margin:0;padding:0;width:100%;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,sans-serif;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-text-size-adjust:100%}body{min-height:100vh;min-height:100dvh;min-height:-webkit-fill-available;overflow:hidden}*{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}#wrap{position:fixed;inset:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:0;box-sizing:border-box;z-index:1}canvas{position:absolute;inset:0;background:#111;touch-action:none;border-radius:0;width:100%;height:100%;max-height:none;z-index:1;pointer-events:auto}#hud{position:fixed;top:calc(var(--safe-top) + 6px);left:0;right:0;text-align:center;font-size:14px;opacity:.9;z-index:2;pointer-events:none;padding-left:var(--safe-left);padding-right:var(--safe-right);box-sizing:border-box}#controls{position:fixed;left:0;right:0;bottom:calc(var(--safe-bottom) + 8px);display:flex;justify-content:center;gap:8px;padding:10px calc(var(--safe-right) + 16px) 10px calc(var(--safe-left) + 16px);box-sizing:border-box;flex-wrap:wrap;z-index:20;pointer-events:auto}button{padding:10px 14px;border:none;border-radius:10px;background:#222;color:#fff;touch-action:manipulation;-webkit-user-select:none;user-select:none;pointer-events:auto}button:active{transform:scale(.98)}#debugPanel{position:fixed;left:8px;right:8px;bottom:calc(var(--safe-bottom) + 70px);max-height:30vh;overflow:auto;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.1);padding:8px 10px;font-size:11px;line-height:1.3;z-index:9;display:none}#debugPanel.active{display:block}#debugPanel .row{white-space:pre-wrap;opacity:.9}#startOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:10;padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);box-sizing:border-box}#startOverlay.hidden{display:none;pointer-events:none}#startOverlay .panel{background:#0b132b;border:1px solid rgba(255,255,255,.1);padding:20px 22px;border-radius:14px;text-align:center;min-width:220px}#startOverlay .title{font-size:18px;margin-bottom:6px}#startOverlay .subtitle{font-size:12px;opacity:.8}#leaderboardPanel{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:11;padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);box-sizing:border-box}#leaderboardPanel.active{display:flex}#leaderboardPanel .card{width:min(92vw,420px);max-height:70vh;overflow:auto;background:#0b132b;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}#leaderboardPanel .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}#leaderboardPanel .head h3{margin:0;font-size:16px}#leaderboardPanel label{font-size:12px;opacity:.8}#leaderboardPanel input{width:100%;margin-top:6px;padding:8px 10px;border-radius:10px;border:1px solid #233;background:#111;color:#fff}#leaderboardPanel .actions{display:flex;gap:8px;margin-top:8px}#leaderboardPanel ol{margin:12px 0 0 18px;padding:0}#leaderboardPanel li{margin:6px 0;font-size:13px}#leaderboardPanel .row{display:flex;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:8px}#leaderboardPanel .row .rank{width:24px;text-align:right;opacity:.85}#leaderboardPanel .row .nick{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#leaderboardPanel .row .score{width:64px;text-align:right;opacity:.9}#leaderboardPanel .rank-1{color:#f5d76e}#leaderboardPanel .rank-2{color:silver}#leaderboardPanel .rank-3{color:#cd7f32}#leaderboardPanel .my-rank-row{margin-top:8px}#leaderboardPanel .me{background:rgba(74,163,255,.12);border:1px solid rgba(74,163,255,.3)}#leaderboardPanel .muted{opacity:.7;font-size:12px}#leaderboardPanel .pill{font-size:11px;padding:2px 6px;border-radius:999px;background:#111;border:1px solid rgba(255,255,255,.1)}#leaderboardPanel .nick-view{display:flex;align-items:center;gap:8px}#leaderboardPanel .nick-edit{display:none;margin-top:8px}#leaderboardPanel .nick-edit.active{display:block}#leaderboardPanel .status{margin-top:6px;font-size:12px}#leaderboardPanel .status.ok{color:#7bd88f}#leaderboardPanel .status.err{color:#ff8a8a}body.modal-open #controls{display:none}body.modal-open #hud{opacity:.4}</style></head><body><div id="hud">Score: <span id="score">0</span> · Best: <span id="best">0</span></div><div id="wrap"><canvas id="game" width="360" height="640"></canvas></div><div id="controls"><button id="restart">Restart</button> <button id="revive" disabled="disabled">Revive (Rewarded)</button> <button id="audio">Audio: On</button> <button id="leaderboard">Top</button> <button id="debugToggle" style="display:none">HUD: On</button></div><div id="startOverlay"><div class="panel"><div class="title">Tap To Start</div><div class="subtitle">Audio starts after your tap</div></div></div><div id="leaderboardPanel"><div class="card"><div class="head"><h3>Top Scores</h3><button id="lbClose">Close</button></div><div id="topList" class="list"></div><div style="height:16px"></div><div class="muted">My Rank</div><div id="myRow" class="row me my-rank-row"><div class="rank" id="myRank">-</div><div class="nick" id="myNick">-</div><div class="score" id="myScore">-</div></div><div style="height:10px"></div><div class="nick-view"><div class="muted">Nickname</div><div class="pill" id="nickDisplay">-</div><button id="nickChange">Change</button></div><div id="nickEdit" class="nick-edit"><label for="nickInput">New Nickname</label> <input id="nickInput" maxlength="12" autocomplete="off" placeholder="3-12 letters/numbers"><div class="actions"><button id="nickSave">Save</button> <button id="nickCancel">Cancel</button> <button id="nickReset">Random</button></div><div id="nickStatus" class="status"></div></div></div></div><div id="debugPanel"></div><script>const APP_VERSION="0.1",bridge={send(e,t={}){window.parent?.postMessage({type:e,payload:t},"*")},on(e,t){window.addEventListener("message",n=>{n.data&&n.data.type===e&&t(n.data.payload||{})})}};bridge.on("INTERSTITIAL_CLOSED",()=>{}),bridge.on("REWARDED_GRANTED",e=>{"revive"===e.rewardType&&(window.__reviveTimer&&clearTimeout(window.__reviveTimer),dbg("bridge: REWARDED_GRANTED revive"),doRevive())}),bridge.on("REWARDED_DENIED",()=>{window.__reviveTimer&&clearTimeout(window.__reviveTimer),dbg("bridge: REWARDED_DENIED")});const canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),scoreEl=document.getElementById("score"),bestEl=document.getElementById("best"),restartBtn=document.getElementById("restart"),reviveBtn=document.getElementById("revive"),audioBtn=document.getElementById("audio"),controlsEl=document.getElementById("controls"),leaderboardBtn=document.getElementById("leaderboard");let lbPanel=document.getElementById("leaderboardPanel"),lbClose=document.getElementById("lbClose"),topList=document.getElementById("topList"),myRankEl=document.getElementById("myRank"),myNickEl=document.getElementById("myNick"),myScoreEl=document.getElementById("myScore"),nickDisplay=document.getElementById("nickDisplay"),nickChange=document.getElementById("nickChange"),nickEdit=document.getElementById("nickEdit"),nickInput=document.getElementById("nickInput"),nickSave=document.getElementById("nickSave"),nickCancel=document.getElementById("nickCancel"),nickReset=document.getElementById("nickReset"),nickStatus=document.getElementById("nickStatus");const debugPanel=document.getElementById("debugPanel"),debugToggle=document.getElementById("debugToggle"),debugEnabled=new URLSearchParams(window.location.search).has("debug"),startOverlay=document.getElementById("startOverlay");function dbg(e){if(!debugEnabled||!debugPanel.classList.contains("active"))return;const t=document.createElement("div");t.className="row",t.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,debugPanel.appendChild(t),debugPanel.scrollTop=debugPanel.scrollHeight,debugPanel.childNodes.length>80&&debugPanel.removeChild(debugPanel.firstChild),console.log(e)}function handleInput(e){modalOpen||(noteUserGesture(),running||(hideStartOverlay(),reset()),player.lane=1-player.lane,dbg(`input: lane=${player.lane}`),audioOn&&sfxTap())}function isControlTarget(e){return!!(e&&e.closest&&e.closest("#controls"))}function getEventPoint(e){return e.touches&&e.touches[0]?{x:e.touches[0].clientX,y:e.touches[0].clientY}:e.changedTouches&&e.changedTouches[0]?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX,y:e.clientY}}function isControlPoint(e){if(!controlsEl)return!1;const t=controlsEl.getBoundingClientRect(),n=getEventPoint(e);return n.x>=t.left&&n.x<=t.right&&n.y>=t.top&&n.y<=t.bottom}function onGlobalInput(e){if(modalOpen||isControlTarget(e.target)||isControlPoint(e))return;e.cancelable&&e.preventDefault();const t=performance.now();t-lastInputAt<200||(lastInputAt=t,handleInput(e))}function showStartOverlay(){startOverlay&&(startOverlay.classList.remove("hidden"),running=!1)}function hideStartOverlay(){startOverlay&&startOverlay.classList.add("hidden")}function ensureLeaderboardPanel(){if(lbPanel)return;const e=document.createElement("div");e.id="leaderboardPanel",e.innerHTML='\n        <div class="card">\n          <div class="head">\n            <h3>Top Scores</h3>\n            <button id="lbClose">Close</button>\n          </div>\n          <div id="topList" class="list"></div>\n          <div style="height:16px"></div>\n          <div class="muted">My Rank</div>\n          <div id="myRow" class="row me my-rank-row">\n            <div class="rank" id="myRank">-</div>\n            <div class="nick" id="myNick">-</div>\n            <div class="score" id="myScore">-</div>\n          </div>\n          <div style="height:10px"></div>\n          <div class="nick-view">\n            <div class="muted">Nickname</div>\n            <div class="pill" id="nickDisplay">-</div>\n            <button id="nickChange">Change</button>\n          </div>\n          <div id="nickEdit" class="nick-edit">\n            <label for="nickInput">New Nickname</label>\n            <input id="nickInput" maxlength="12" autocomplete="off" placeholder="3-12 letters/numbers">\n            <div class="actions">\n              <button id="nickSave">Save</button>\n              <button id="nickCancel">Cancel</button>\n              <button id="nickReset">Random</button>\n            </div>\n            <div id="nickStatus" class="status"></div>\n          </div>\n        </div>\n      ',document.body.appendChild(e),lbPanel=e,lbClose=e.querySelector("#lbClose"),topList=e.querySelector("#topList"),myRankEl=e.querySelector("#myRank"),myNickEl=e.querySelector("#myNick"),myScoreEl=e.querySelector("#myScore"),nickDisplay=e.querySelector("#nickDisplay"),nickChange=e.querySelector("#nickChange"),nickEdit=e.querySelector("#nickEdit"),nickInput=e.querySelector("#nickInput"),nickSave=e.querySelector("#nickSave"),nickCancel=e.querySelector("#nickCancel"),nickReset=e.querySelector("#nickReset"),nickStatus=e.querySelector("#nickStatus"),lbClose&&lbClose.addEventListener("click",e=>{e.preventDefault(),closeLeaderboard()}),nickSave&&nickSave.addEventListener("click",e=>{e.preventDefault(),applyNickname(nickInput.value.trim())}),nickCancel&&nickCancel.addEventListener("click",e=>{e.preventDefault(),toggleNickEdit(!1)}),nickReset&&nickReset.addEventListener("click",e=>{e.preventDefault(),applyNickname(randomNick())}),nickChange&&nickChange.addEventListener("click",e=>{e.preventDefault(),toggleNickEdit(!0)})}function openLeaderboard(){modalOpen||(ensureLeaderboardPanel(),lbPanel&&(dbg("leaderboard: open"),document.body.classList.add("modal-open"),modalOpen=!0,pausedByModal=running,running=!1,lbPanel.classList.add("active"),refreshLeaderboard()))}function closeLeaderboard(){lbPanel&&(lbPanel.classList.remove("active"),document.body.classList.remove("modal-open"),modalOpen=!1,pausedByModal&&(running=!0,pausedByModal=!1,lastMs=performance.now()))}function renderLeaderboard(e){if(topList){if(topList.innerHTML="",!e||0===e.length){const e=document.createElement("div");return e.className="muted",e.textContent="No scores yet",void topList.appendChild(e)}e.slice(0,10).forEach((e,t)=>{const n=document.createElement("div");n.className="row",0===t&&n.classList.add("rank-1"),1===t&&n.classList.add("rank-2"),2===t&&n.classList.add("rank-3"),n.innerHTML=`\n          <div class="rank">${t+1}</div>\n          <div class="nick">${e.nick||"Runner"}</div>\n          <div class="score">${e.score??"-"}</div>\n        `,topList.appendChild(n)})}}function setMyRow(e,t,n,a){myRankEl&&(myRankEl.textContent=e?a?e:`≈${e}`:"-"),myNickEl&&(myNickEl.textContent=t??"-"),myScoreEl&&(myScoreEl.textContent=n??"-")}async function refreshLeaderboard(){if(!window.FirebaseClient?.getTop)return renderLeaderboard([]),void setMyRow("-","-","-");try{renderLeaderboard(await window.FirebaseClient.getTop(10))}catch{renderLeaderboard([])}try{const e=await(window.FirebaseClient.getMyRank?.());e&&e.rank?setMyRow(e.rank,e.nick,e.score,e.exact):setMyRow("-","-","-")}catch{setMyRow("-","-","-")}}function bridgeAvailable(){return!!window.AndroidBridge}function onReviveRequested(){noteUserGesture(),dbg("revive: requested"),bridgeAvailable()?(window.__reviveTimer&&clearTimeout(window.__reviveTimer),window.__reviveTimer=setTimeout(()=>{dbg("revive: timeout fallback"),doRevive()},800),bridge.send("REQUEST_REWARDED",{reason:"revive"})):doRevive()}function onRestartRequested(){noteUserGesture(),reset()}function showNickStatus(e,t=!0){nickStatus&&(nickStatus.textContent=e||"",nickStatus.className="status "+(t?"ok":"err"))}function toggleNickEdit(e){nickEdit&&(nickEdit.classList.toggle("active",!!e),e&&(nickInput&&(nickInput.value=""),showNickStatus("")))}function applyNickname(e){e&&window.FirebaseClient?.setNick&&window.FirebaseClient.setNick(e).then(()=>{nickDisplay&&(nickDisplay.textContent=e),nickInput&&(nickInput.value=e),showNickStatus("Saved"),toggleNickEdit(!1),refreshLeaderboard()}).catch(e=>{showNickStatus(e?.message||"Nickname not available",!1)})}function randomNick(){const e=["Runner","Swift","Dash","Rush","Blaze","Bolt","Flash","Drift","Comet","Vortex","Nova","Turbo"];return`${e[Math.floor(Math.random()*e.length)]}${Math.floor(10+90*Math.random())}`}if(debugEnabled&&(debugPanel.classList.add("active"),debugToggle&&(debugToggle.style.display="inline-block",debugToggle.textContent="HUD: On")),ensureLeaderboardPanel(),nickInput&&!nickInput.value){applyNickname(localStorage.getItem("nick")||randomNick())}function onAudioToggle(){audioOn=!audioOn,audioBtn.textContent=audioOn?"Audio: On":"Audio: Off",dbg("audio: "+(audioOn?"on":"off")),audioOn?noteUserGesture():audioCtx&&"running"===audioCtx.state&&audioCtx.suspend()}let viewW=canvas.width,viewH=canvas.height,playAreaBottom=viewH;function getSafeBottom(){const e=getComputedStyle(document.documentElement).getPropertyValue("--safe-bottom"),t=parseFloat(e);return Number.isFinite(t)?t:0}function resizeCanvas(){const e=Math.max(1,Math.min(2,window.devicePixelRatio||1)),t=window.visualViewport,n=Math.max(1,Math.floor(t?t.width:window.innerWidth)),a=Math.max(1,Math.floor(t?t.height:window.innerHeight));viewW=n,viewH=a,canvas.width=Math.floor(n*e),canvas.height=Math.floor(a*e),ctx.setTransform(e,0,0,e,0,0);const i=controlsEl?controlsEl.offsetHeight:0,o=getSafeBottom();playAreaBottom=Math.max(0,viewH-i-o-12)}const lanes=[.33*viewW,.67*viewW],player={lane:0,y:viewH-90,r:18},obstacles=[];let running=!1,score=0,best=Number(localStorage.getItem("best")||0),startMs=0,dead=!1,canRevive=!1,invincibleMs=0,spawnTimer=0,lastMs=0,audioOn=!0,lastInputAt=0,lastControlAt=0,modalOpen=!1,pausedByModal=!1,audioCtx=null,musicTimer=0,musicStep=0,userGestureSeen=!1,audioUnlocked=!1;function startAudioIfNeeded(){return!(!audioOn||!userGestureSeen)&&(audioCtx||(audioCtx=new AudioContext),"suspended"===audioCtx.state&&audioCtx.resume(),audioUnlocked||(audioUnlocked=!0,dbg("audio: unlocked")),!0)}function noteUserGesture(){userGestureSeen||(userGestureSeen=!0),startAudioIfNeeded()}function tone(e,t=.08,n=.05,a="sine"){if(!audioCtx)return;const i=audioCtx.currentTime,o=audioCtx.createOscillator(),r=audioCtx.createGain();o.type=a,o.frequency.value=e,r.gain.value=1e-4,o.connect(r),r.connect(audioCtx.destination),o.start(i),r.gain.exponentialRampToValueAtTime(n,i+.01),r.gain.exponentialRampToValueAtTime(1e-4,i+t),o.stop(i+t+.02)}function sfxTap(){tone(420,.05,.06,"triangle")}function sfxScore(){tone(640,.06,.05,"sine")}function sfxHit(){tone(140,.12,.07,"square")}const musicSeq=[196,0,220,0,196,0,246,0,196,0,220,0,196,0,174,0];function updateMusic(e){if(!audioOn)return;if(!audioCtx)return;const t=Math.max(.12,.22-.003*Math.min(score,30));if(musicTimer-=e,musicTimer<=0){musicTimer=t;const e=musicSeq[musicStep%musicSeq.length];e>0&&tone(e,.8*t,.03,"sawtooth"),musicStep++}}function reset(){resizeCanvas(),lanes[0]=.33*viewW,lanes[1]=.67*viewW,player.y=Math.min(viewH-90,playAreaBottom-30),hideStartOverlay(),running=!0,dead=!1,canRevive=!1,reviveBtn.disabled=!0,player.lane=0,score=0,scoreEl.textContent="0",obstacles.length=0,spawnTimer=0,invincibleMs=0,startMs=performance.now(),lastMs=performance.now(),bridge.send("GAME_START",{}),dbg("bridge: GAME_START")}function submitScoreToCloud(e){e<best||(window.FirebaseClient?.submitScore?window.FirebaseClient.submitScore(e):(window.__pendingScores=window.__pendingScores||[]).push(e))}function gameOver(){if(dead)return;dead=!0,running=!1;const e=Math.max(0,performance.now()-startMs);bridge.send("GAME_OVER",{score:score,durationMs:e}),dbg(`bridge: GAME_OVER score=${score} dur=${Math.floor(e)}ms`),canRevive=!0,reviveBtn.disabled=!1,bridge.send("REQUEST_INTERSTITIAL",{reason:"game_over"}),dbg("bridge: REQUEST_INTERSTITIAL"),score>best&&(best=score,localStorage.setItem("best",String(best)),bestEl.textContent=best),submitScoreToCloud(score),audioOn&&sfxHit()}function doRevive(){if(canRevive){canRevive=!1,reviveBtn.disabled=!0,running=!0,dead=!1,invincibleMs=1500,dbg("revive: applied");for(let e=obstacles.length-1;e>=0;e--)obstacles[e].y>player.y-120&&obstacles.splice(e,1)}}function toggleHud(){if(!debugEnabled)return;const e=debugPanel.classList.toggle("active");debugToggle&&(debugToggle.textContent=e?"HUD: On":"HUD: Off")}if(bestEl.textContent=best,startOverlay&&(startOverlay.addEventListener("pointerdown",e=>{e.preventDefault(),hideStartOverlay(),noteUserGesture(),reset()}),startOverlay.addEventListener("touchstart",e=>{e.preventDefault(),hideStartOverlay(),noteUserGesture(),reset()},{passive:!1}),startOverlay.addEventListener("click",e=>{e.preventDefault(),hideStartOverlay(),noteUserGesture(),reset()})),leaderboardBtn&&(leaderboardBtn.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),openLeaderboard()}),leaderboardBtn.addEventListener("pointerup",e=>{e.preventDefault(),e.stopPropagation(),openLeaderboard()}),leaderboardBtn.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),openLeaderboard()},{passive:!1}),leaderboardBtn.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation(),openLeaderboard()},{passive:!1}),leaderboardBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),openLeaderboard()}),leaderboardBtn.onclick=e=>{e.preventDefault(),e.stopPropagation(),openLeaderboard()}),controlsEl){const e=e=>{const t=e.target;t&&"leaderboard"===t.id&&(e.preventDefault(),e.stopPropagation(),openLeaderboard())};controlsEl.addEventListener("pointerdown",e,!0),controlsEl.addEventListener("pointerup",e,!0),controlsEl.addEventListener("touchstart",e,{passive:!1,capture:!0}),controlsEl.addEventListener("touchend",e,{passive:!1,capture:!0}),controlsEl.addEventListener("click",e,!0)}function handleControlAction(e){e.preventDefault(),e.stopPropagation();const t=performance.now();if(t-lastControlAt<200)return;lastControlAt=t;const n=e.target;n&&(n===reviveBtn?onReviveRequested():n===restartBtn?onRestartRequested():n===audioBtn?onAudioToggle():n===leaderboardBtn?openLeaderboard():n===debugToggle&&toggleHud())}function spawnObstacle(){const e=Math.random()<.5?0:1;obstacles.push({lane:e,y:-30,w:80,h:26})}function update(e){if(!running)return;if(updateMusic(e),spawnTimer-=e,spawnTimer<=0){const e=Math.max(.45,.75-.008*Math.min(score,40));spawnTimer=e,spawnObstacle()}const t=260+12*score;for(let n=obstacles.length-1;n>=0;n--){const a=obstacles[n];if(a.y+=t*e,a.y-a.h/2>viewH+10)obstacles.splice(n,1),score+=1,scoreEl.textContent=String(score),audioOn&&sfxScore();else if(a.lane===player.lane&&invincibleMs<=0){Math.abs(a.y-player.y)<a.h/2+player.r&&gameOver()}}invincibleMs>0&&(invincibleMs-=1e3*e)}function draw(){ctx.clearRect(0,0,viewW,viewH);const e=.001*performance.now(),t=ctx.createLinearGradient(0,0,0,viewH);t.addColorStop(0,"#0b132b"),t.addColorStop(1,"#1b263b"),ctx.fillStyle=t,ctx.fillRect(0,0,viewW,viewH),ctx.strokeStyle="rgba(255,255,255,0.08)",ctx.lineWidth=2;for(let t=0;t<6;t++){const n=(t+1)*viewW/7,a=(140*e+120*t)%viewH;ctx.beginPath(),ctx.moveTo(n,a),ctx.lineTo(n,a+80),ctx.stroke()}ctx.strokeStyle="#222",ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(viewW/2,0),ctx.lineTo(viewW/2,viewH),ctx.stroke();for(const e of obstacles){ctx.fillStyle="#e74c3c";const t=lanes[e.lane]-e.w/2,n=e.y-e.h/2;ctx.fillRect(t,n,e.w,e.h)}ctx.fillStyle=invincibleMs>0?"#f1c40f":"#4aa3ff",ctx.beginPath(),ctx.arc(lanes[player.lane],player.y,player.r,0,2*Math.PI),ctx.fill();const n=ctx.createRadialGradient(viewW/2,viewH/2,50,viewW/2,viewH/2,viewW);n.addColorStop(0,"rgba(0,0,0,0)"),n.addColorStop(1,"rgba(0,0,0,0.45)"),ctx.fillStyle=n,ctx.fillRect(0,0,viewW,viewH),dead&&(ctx.fillStyle="#fff",ctx.font="20px system-ui, sans-serif",ctx.fillText("Game Over",viewW/2-55,viewH/2),ctx.font="14px system-ui, sans-serif",ctx.fillText("Tap Restart or Revive",viewW/2-70,viewH/2+24))}function loop(e){const t=Math.min(.032,(e-lastMs)/1e3);lastMs=e,update(t),draw(),requestAnimationFrame(loop)}function onViewportResize(){resizeCanvas(),lanes[0]=.33*viewW,lanes[1]=.67*viewW,player.y=Math.min(viewH-90,playAreaBottom-30)}lbClose&&lbClose.addEventListener("click",e=>{e.preventDefault(),closeLeaderboard()}),nickSave&&nickSave.addEventListener("click",e=>{e.preventDefault(),applyNickname(nickInput.value.trim())}),nickCancel&&nickCancel.addEventListener("click",e=>{e.preventDefault(),toggleNickEdit(!1)}),nickReset&&nickReset.addEventListener("click",e=>{e.preventDefault(),applyNickname(randomNick())}),nickChange&&nickChange.addEventListener("click",e=>{e.preventDefault(),toggleNickEdit(!0)}),nickDisplay&&(nickDisplay.textContent=localStorage.getItem("nick")||"-"),reviveBtn.addEventListener("pointerdown",handleControlAction),reviveBtn.addEventListener("touchstart",handleControlAction,{passive:!1}),reviveBtn.addEventListener("click",handleControlAction),restartBtn.addEventListener("pointerdown",handleControlAction),restartBtn.addEventListener("touchstart",handleControlAction,{passive:!1}),restartBtn.addEventListener("click",handleControlAction),audioBtn.addEventListener("pointerdown",handleControlAction),audioBtn.addEventListener("touchstart",handleControlAction,{passive:!1}),audioBtn.addEventListener("click",handleControlAction),leaderboardBtn.addEventListener("pointerdown",handleControlAction),leaderboardBtn.addEventListener("touchstart",handleControlAction,{passive:!1}),leaderboardBtn.addEventListener("click",handleControlAction),debugToggle&&(debugToggle.addEventListener("pointerdown",handleControlAction),debugToggle.addEventListener("touchstart",handleControlAction,{passive:!1}),debugToggle.addEventListener("click",handleControlAction)),canvas.addEventListener("pointerdown",e=>{modalOpen||(e.preventDefault(),handleInput(e))}),canvas.addEventListener("touchstart",e=>{modalOpen||(e.preventDefault(),handleInput(e))},{passive:!1}),canvas.addEventListener("mousedown",e=>{modalOpen||(e.preventDefault(),handleInput(e))}),canvas.addEventListener("click",e=>{modalOpen||(e.preventDefault(),handleInput(e))}),document.addEventListener("pointerdown",onGlobalInput,!0),document.addEventListener("touchstart",onGlobalInput,{passive:!1,capture:!0}),document.addEventListener("mousedown",onGlobalInput,!0),document.addEventListener("click",onGlobalInput,!0),window.addEventListener("resize",onViewportResize),window.visualViewport&&(window.visualViewport.addEventListener("resize",onViewportResize),window.visualViewport.addEventListener("scroll",onViewportResize)),resizeCanvas(),requestAnimationFrame(loop),reset(),showStartOverlay(),document.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("selectstart",e=>e.preventDefault())</script><script type="module">import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";import{getAuth,signInAnonymously,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";import{getFirestore,doc,setDoc,serverTimestamp,collection,query,orderBy,limit,getDocs,getDoc,where,getCountFromServer,runTransaction}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyAP64ztM7l4rMaODH3OXhq6cmDcKq-jDno",authDomain:"laneflipsprint.firebaseapp.com",projectId:"laneflipsprint",storageBucket:"laneflipsprint.firebasestorage.app",messagingSenderId:"122169792197",appId:"1:122169792197:web:41b87a533ca68cd8bd42ac",measurementId:"G-T26CQ355X0"},app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),params=new URLSearchParams(window.location.search),GAME_ID=params.get("gid")||"lane-flip-sprint",GAME_DOC=doc(db,"games",GAME_ID),state={uid:null,nick:localStorage.getItem("nick")||null,ready:!1,sortDirection:"desc",rankType:"score"};function playersDoc(e){return doc(db,"games",GAME_ID,"players",e)}function leaderboardDoc(e){return doc(db,"games",GAME_ID,"leaderboard",e)}function leaderboardCol(){return collection(db,"games",GAME_ID,"leaderboard")}function nicknamesDoc(e){return doc(db,"games",GAME_ID,"nicknames",e)}function compareBetter(e,t){return"asc"===state.sortDirection?e<t:e>t}function rankValueFromRaw(e){return Number(e)}async function loadGameConfig(){try{const e=await getDoc(GAME_DOC);if(e.exists()){const t=e.data()||{};"asc"!==t.sortDirection&&"desc"!==t.sortDirection||(state.sortDirection=t.sortDirection),"string"==typeof t.rankType&&t.rankType.trim()&&(state.rankType=t.rankType)}}catch(e){console.warn("game config read failed, using defaults",e)}}function getLocalBest(){const e=localStorage.getItem("best"),t=e?Number(e):0;return Number.isFinite(t)?t:0}function normalizeNick(e){return(e||"").trim().normalize("NFKC")}function isNickValid(e){const t=normalizeNick(e);return!(t.length<2||t.length>12)&&/^[\p{L}\p{N}_]+$/u.test(t)}async function claimNickname(e,t){const a=normalizeNick(t);if(!isNickValid(a))throw new Error("2-12 letters/numbers/underscore (no spaces)");const r=a.toLowerCase();return await runTransaction(db,async t=>{const n=nicknamesDoc(r),i=await t.get(n);if(i.exists()&&i.data()?.uid!==e)throw new Error("Nickname already taken");t.set(n,{uid:e,nick:a,updatedAt:serverTimestamp()},{merge:!0})}),a}function randomAsciiNick(){const e=["Runner","Swift","Dash","Rush","Blaze","Bolt","Flash","Drift","Comet","Vortex","Nova","Turbo"];return`${e[Math.floor(Math.random()*e.length)]}${Math.floor(100+900*Math.random())}`}async function generateUniqueNick(e){let t=null;for(let a=0;a<30;a++)try{return await claimNickname(e,randomAsciiNick())}catch(e){t=e;if(!String(e?.message||"").toLowerCase().includes("taken"))throw e}throw t||new Error("Nickname generation failed")}async function ensureNick(e){const t=normalizeNick(state.nick);if(!t||"player"===t.toLowerCase())state.nick=await generateUniqueNick(e);else try{state.nick=await claimNickname(e,t)}catch(t){state.nick=await generateUniqueNick(e)}localStorage.setItem("nick",state.nick);const a=getLocalBest();try{await setDoc(playersDoc(e),{nick:state.nick,bestRawValue:a,bestRankValue:rankValueFromRaw(a),updatedAt:serverTimestamp()},{merge:!0})}catch(e){}}async function submitScore(e){if(!state.uid)return;const t=rankValueFromRaw(e),a=localStorage.getItem("nick")||state.nick||"Runner100",r=playersDoc(state.uid),n=leaderboardDoc(state.uid);try{await runTransaction(db,async i=>{const s=await i.get(r),o=s.exists()?Number(s.data()?.bestRawValue??s.data()?.bestScore??0):null;(null===o||compareBetter(e,o))&&(i.set(n,{uid:state.uid,nick:a,rawValue:e,rankValue:t,updatedAt:serverTimestamp()},{merge:!0}),i.set(r,{nick:a,bestRawValue:e,bestRankValue:t,updatedAt:serverTimestamp()},{merge:!0}))}),console.log("score saved",{gameId:GAME_ID,uid:state.uid,score:e,rankValue:t})}catch(t){console.warn("submitScore transaction failed, fallback to basic write",t),await async function(){try{const[t,i]=await Promise.all([getDoc(r),getDoc(n)]),s=t.exists()?Number(t.data()?.bestRawValue??t.data()?.bestScore??0):null,o=i.exists()?Number(i.data()?.rawValue??i.data()?.score??0):null;let c=e;null===s||compareBetter(e,s)||(c=s),null===o||compareBetter(c,o)||(c=o);const u=rankValueFromRaw(c);await setDoc(n,{uid:state.uid,nick:a,rawValue:c,rankValue:u,updatedAt:serverTimestamp()},{merge:!0}),await setDoc(r,{nick:a,bestRawValue:c,bestRankValue:u,updatedAt:serverTimestamp()},{merge:!0})}catch(e){console.error("submitScore fallback failed",e)}}()}}async function getTop(e){const t=query(leaderboardCol(),orderBy("rankValue",state.sortDirection),limit(e));return(await getDocs(t)).docs.map(e=>{const t=e.data()||{};return{uid:t.uid||e.id,nick:t.nick||"Runner",score:Number(t.rawValue??t.score??0)}})}async function setNick(e){if(!state.uid)return;const t=await claimNickname(state.uid,e);state.nick=t,localStorage.setItem("nick",t);const a=getLocalBest(),r=rankValueFromRaw(a);try{await setDoc(playersDoc(state.uid),{nick:t,bestRawValue:a,bestRankValue:r,updatedAt:serverTimestamp()},{merge:!0})}catch(e){}try{await setDoc(leaderboardDoc(state.uid),{uid:state.uid,nick:t,rawValue:a,rankValue:r,updatedAt:serverTimestamp()},{merge:!0})}catch(e){}return t}async function getMyRank(){if(!state.uid)return null;const e=leaderboardDoc(state.uid),t=await getDoc(e);if(!t.exists())return null;const a=t.data(),r=Number(a.rawValue??a.score??0),n=Number(a.rankValue??r),i=a.nick||state.nick||"Runner",s=(await getTop(10)).findIndex(e=>(e.uid||"")===state.uid);if(s>=0)return{rank:s+1,score:r,nick:i,exact:!0};const o="asc"===state.sortDirection?"<":">",c=query(leaderboardCol(),where("rankValue",o,n));return{rank:((await getCountFromServer(c)).data().count||0)+1,score:r,nick:i,exact:!1}}window.FirebaseClient={submitScore:submitScore,getTop:getTop,setNick:setNick,getMyRank:getMyRank,ready:!1},loadGameConfig().finally(()=>{signInAnonymously(auth).catch(()=>{})}),onAuthStateChanged(auth,async e=>{if(e&&(state.uid=e.uid,await ensureNick(e.uid),window.FirebaseClient.ready=!0,window.__pendingScores&&window.__pendingScores.length)){const e=window.__pendingScores.slice();window.__pendingScores.length=0,e.forEach(e=>submitScore(e))}})</script></body></html>