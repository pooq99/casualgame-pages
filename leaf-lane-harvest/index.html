<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="game-id" content="leaf-lane-harvest"><meta name="game-version" content="0.3.0"><title>Leaf Lane Harvest</title><style>:root{--bg:#e7f3d1;--ink:#1f2d19;--panel:#fff9e8;--accent:#2e8a4f;--danger:#9f3530;--line:#b7d08b;--gold:#cb9f28;--silver:#8897a6;--bronze:#9d6c48}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body,html{overscroll-behavior:none}body{margin:0;min-height:100vh;background:radial-gradient(circle at 30% 20%,#f7ffe7 0,#e9f3d3 58%,#dce9be 100%);font-family:"Trebuchet MS","Segoe UI",sans-serif;color:var(--ink);display:flex;justify-content:center;overflow:hidden;touch-action:none;user-select:none}.app{width:min(100vw,520px);padding:10px;padding-top:calc(14px + env(safe-area-inset-top));padding-bottom:calc(18px + env(safe-area-inset-bottom))}.topbar{display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:8px;margin-bottom:8px}.pill{border:2px solid var(--line);border-radius:10px;background:#fffef5d9;text-align:center;font-weight:700;font-size:13px;padding:8px 6px}button{border:none;border-radius:10px;padding:9px 10px;font-weight:700;background:var(--accent);color:#fff;cursor:pointer}#stageWrap{position:relative;border:3px solid #7f9f57;border-radius:14px;overflow:hidden;background:linear-gradient(#9cd370,#7dbc59);box-shadow:inset 0 -40px 120px rgba(33,52,16,.25);touch-action:none}canvas{width:100%;height:auto;display:block;touch-action:none}.hint{min-height:18px;text-align:center;margin-top:6px;font-size:13px;opacity:.9}.controls{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}.leftpad{display:grid;grid-template-columns:1fr 1fr;gap:8px}.btn-big{min-height:56px;font-size:18px;border:2px solid #245f38;background:#3da460}.btn-jump{min-height:56px;font-size:18px;border:2px solid #245f38;background:#2f7f46}.modal,.overlay{position:fixed;inset:0;background:rgba(17,24,9,.58);display:none;align-items:center;justify-content:center;padding:14px;z-index:10}.modal.show,.overlay.show{display:flex}.panel{width:min(100%,460px);background:var(--panel);border-radius:14px;border:2px solid #dac892;padding:14px}.panel h2{margin:0 0 8px;font-size:21px}.row{display:flex;align-items:center;gap:8px}.row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}input[type=text]{flex:1;border:2px solid #d5c38e;border-radius:10px;padding:8px;font-size:14px;min-width:0}.lb-list{list-style:none;margin:10px 0;padding:0;border:1px solid #e8dbb4;border-radius:10px;max-height:280px;overflow:auto;background:#fffdf4}.lb-item{display:grid;grid-template-columns:34px 1fr auto;gap:8px;padding:7px 10px;border-bottom:1px solid #f2e8cc;font-size:14px}.lb-item:last-child{border-bottom:none}.rank-1{color:var(--gold);font-weight:800}.rank-2{color:var(--silver);font-weight:800}.rank-3{color:var(--bronze);font-weight:800}.my-rank{font-size:14px;background:#fff5d6;border:2px solid #efd290;border-radius:10px;padding:8px 10px}</style></head><body><div class="app"><div class="topbar"><div class="pill">Stage <span id="stageLabel">1</span>/5</div><div class="pill">Time <span id="time">0.0</span>s</div><div class="pill">Score <span id="score">0</span></div><button id="topBtn">Top</button> <button id="restartBtn">Restart</button></div><div id="stageWrap"><canvas id="stage" width="420" height="760" aria-label="game field"></canvas></div><div id="hint" class="hint">Left/Right + Jump. Clear all 5 stages.</div><div class="controls"><div class="leftpad"><button id="leftBtn" class="btn-big">◀</button> <button id="rightBtn" class="btn-big">▶</button></div><button id="jumpBtn" class="btn-jump">JUMP</button></div></div><div id="stageClearOverlay" class="overlay"><div class="panel"><h2>Stage Clear</h2><p id="stageClearText">Nice run.</p><div class="row"><button id="nextStageBtn">Next Stage</button></div></div></div><div id="reviveOverlay" class="overlay"><div class="panel"><h2>Revive once?</h2><p id="reviveText">Use rewarded ad in wrapper to continue.</p><div class="row"><button id="reviveBtn">Revive</button> <button id="skipReviveBtn" style="background:#8f322f">No Thanks</button></div></div></div><div id="gameOverOverlay" class="overlay"><div class="panel"><h2 id="resultTitle">Run Ended</h2><p>Score: <strong id="finalScore">0</strong></p><p>Duration: <strong id="finalTime">0.00s</strong></p><div class="row"><button id="playAgainBtn">Play Again</button></div></div></div><div id="leaderboardModal" class="modal"><div class="panel"><h2>Global Top 10</h2><div id="latestRun" class="my-rank" style="display:none;margin-bottom:8px"></div><div class="row"><input id="nickInput" maxlength="20" disabled="disabled"> <button id="changeNickBtn">Change</button> <button id="saveNickBtn" style="display:none">Save</button></div><ul id="lbList" class="lb-list"></ul><div id="myRank" class="my-rank">My Rank: -</div><div class="row-end"><button id="closeLbBtn">Close</button></div></div></div><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script><script>!function(){"use strict";const e="leaf-lane-harvest",t="0.3.0",n="desc",a="score",i=e+":nick",l=e+":best",r=e+":interstitial:last",o={stage:document.getElementById("stage"),stageLabel:document.getElementById("stageLabel"),time:document.getElementById("time"),score:document.getElementById("score"),hint:document.getElementById("hint"),topBtn:document.getElementById("topBtn"),restartBtn:document.getElementById("restartBtn"),leftBtn:document.getElementById("leftBtn"),rightBtn:document.getElementById("rightBtn"),jumpBtn:document.getElementById("jumpBtn"),stageClearOverlay:document.getElementById("stageClearOverlay"),stageClearText:document.getElementById("stageClearText"),nextStageBtn:document.getElementById("nextStageBtn"),reviveOverlay:document.getElementById("reviveOverlay"),reviveBtn:document.getElementById("reviveBtn"),skipReviveBtn:document.getElementById("skipReviveBtn"),reviveText:document.getElementById("reviveText"),gameOverOverlay:document.getElementById("gameOverOverlay"),resultTitle:document.getElementById("resultTitle"),finalScore:document.getElementById("finalScore"),finalTime:document.getElementById("finalTime"),playAgainBtn:document.getElementById("playAgainBtn"),leaderboardModal:document.getElementById("leaderboardModal"),lbList:document.getElementById("lbList"),myRank:document.getElementById("myRank"),latestRun:document.getElementById("latestRun"),nickInput:document.getElementById("nickInput"),changeNickBtn:document.getElementById("changeNickBtn"),saveNickBtn:document.getElementById("saveNickBtn"),closeLbBtn:document.getElementById("closeLbBtn")},s=o.stage.getContext("2d");const c={running:!1,modalOpen:!1,awaitingRevive:!1,reviveUsed:!1,startedSent:!1,elapsedMs:0,score:0,best:Number(localStorage.getItem(l)||0),stageIndex:0,cameraX:0,stageProgressScore:0,leavesTaken:0,input:{left:!1,right:!1,jumpQueued:!1},player:{x:80,y:620,w:30,h:40,vx:0,vy:0,onGround:!1,facing:1},checkpoint:{x:80,y:620},invuln:0,lastFrame:0,db:null,uid:null,nick:"",nickKeyLower:"",latestSubmitted:null},d=[{name:"Garden Gate",length:1700,surfaces:[[0,694,540,66],[610,694,350,66],[1040,694,300,66],[1410,694,290,66],[270,590,130,18],[500,550,120,18],[780,590,120,18],[1170,540,140,18]],hazards:[{type:"spike",x:560,y:674,w:48,h:20},{type:"roller",x1:700,x2:910,y:670,r:13,speed:1.4},{type:"flame",x:1230,y:644,w:24,h:50,cycle:1.8,duty:.6}],leaves:[[340,560],[560,520],[850,560],[1200,510],[1490,650]]},{name:"Fence Run",length:1800,surfaces:[[0,694,360,66],[440,694,240,66],[760,694,210,66],[1060,694,260,66],[1380,694,420,66],[300,610,120,18],[670,575,110,18],[990,610,110,18],[1270,560,120,18]],hazards:[{type:"spike",x:380,y:674,w:52,h:20},{type:"dropper",x:705,yTop:430,yBottom:650,w:26,h:28,speed:1.7},{type:"roller",x1:1120,x2:1320,y:670,r:14,speed:1.8},{type:"flame",x:1500,y:644,w:24,h:50,cycle:1.5,duty:.56}],leaves:[[180,650],[500,650],[730,530],[1030,570],[1335,525],[1620,650]]},{name:"Stone Steps",length:1900,surfaces:[[0,694,310,66],[360,650,180,18],[600,610,160,18],[820,570,150,18],[1020,530,140,18],[1220,570,140,18],[1440,620,170,18],[1680,694,220,66]],hazards:[{type:"spike",x:550,y:674,w:44,h:20},{type:"spike",x:970,y:674,w:44,h:20},{type:"dropper",x:1160,yTop:360,yBottom:610,w:24,h:30,speed:1.6},{type:"roller",x1:1500,x2:1680,y:596,r:12,speed:1.9}],leaves:[[250,650],[420,610],[650,570],[870,530],[1080,492],[1490,585],[1760,650]]},{name:"Ivy Bridge",length:2e3,surfaces:[[0,694,440,66],[520,640,170,18],[770,590,170,18],[1020,540,170,18],[1270,590,170,18],[1520,640,170,18],[1760,694,240,66]],hazards:[{type:"flame",x:480,y:644,w:24,h:50,cycle:1.7,duty:.5},{type:"roller",x1:820,x2:980,y:570,r:12,speed:2},{type:"dropper",x:1330,yTop:360,yBottom:610,w:24,h:32,speed:1.8},{type:"spike",x:1700,y:674,w:48,h:20}],leaves:[[230,650],[600,605],[850,555],[1100,505],[1370,555],[1600,605],[1870,650]]},{name:"Harvest Road",length:2200,surfaces:[[0,694,380,66],[460,694,280,66],[820,640,160,18],[1060,694,220,66],[1360,620,180,18],[1620,694,260,66],[1960,694,240,66]],hazards:[{type:"spike",x:400,y:674,w:44,h:20},{type:"roller",x1:840,x2:1020,y:620,r:13,speed:2.1},{type:"flame",x:1320,y:644,w:24,h:50,cycle:1.3,duty:.58},{type:"dropper",x:1750,yTop:360,yBottom:670,w:24,h:34,speed:2}],leaves:[[150,650],[540,650],[900,590],[1140,650],[1410,570],[1700,650],[2070,650]]}];function u(e){return String(e||"").trim().toLowerCase().replace(/\s+/g," ").slice(0,20)}function y(e,t){const n=JSON.stringify({type:e,payload:t||{}});window.ReactNativeWebView&&"function"==typeof window.ReactNativeWebView.postMessage&&window.ReactNativeWebView.postMessage(n)}function p(e){return(e/1e3).toFixed(2)+"s"}function f(e,t,n){return Math.max(t,Math.min(n,e))}function m(){return d[c.stageIndex]}function g(e,t){c.stageIndex=e;const n=m();t||(c.checkpoint.x=80,c.checkpoint.y=620),c.player.x=t?c.checkpoint.x:80,c.player.y=t?c.checkpoint.y:620,c.player.vx=0,c.player.vy=0,c.player.onGround=!1,c.cameraX=0,o.stageLabel.textContent=String(e+1),n.leafStates=n.leaves.map(function(e){return{x:e[0],y:e[1],taken:!1}})}function v(){c.running=!0,c.modalOpen=!1,c.awaitingRevive=!1,c.reviveUsed=!1,c.startedSent=!1,c.elapsedMs=0,c.score=0,c.stageProgressScore=0,c.leavesTaken=0,c.invuln=0,c.lastFrame=0,g(0,!1),o.score.textContent="0",o.time.textContent="0.0",o.hint.textContent="Left/Right + Jump. Clear all 5 stages.",o.stageClearOverlay.classList.remove("show"),o.reviveOverlay.classList.remove("show"),o.gameOverOverlay.classList.remove("show"),o.latestRun.style.display="none";for(let e=0;e<d.length;e++)d[e].leafStates=d[e].leaves.map(function(e){return{x:e[0],y:e[1],taken:!1}})}function h(){const e=m(),t=Math.floor(c.player.x/Math.max(1,e.length)*2e3);return 2500*c.stageIndex+t+70*c.leavesTaken}function k(e){c.running=!1,c.awaitingRevive=!1,c.modalOpen=!1,o.stageClearOverlay.classList.remove("show"),o.reviveOverlay.classList.remove("show"),o.gameOverOverlay.classList.add("show");const t=Math.max(1,Math.round(c.elapsedMs));let n=h();e?(n+=4500,o.resultTitle.textContent="All Stages Cleared"):o.resultTitle.textContent="Run Ended",c.score=n,c.latestSubmitted={score:n,durationMs:t},o.finalScore.textContent=String(n),o.finalTime.textContent=p(t),o.latestRun.style.display="block",o.latestRun.textContent="Latest run: "+n+" points in "+p(t),n>c.best&&(c.best=n,localStorage.setItem(l,String(n))),y("GAME_OVER",{score:n,durationMs:t}),function(){try{const e=Date.now(),t=Number(localStorage.getItem(r)||0);return!(t&&e-t<35e3||(localStorage.setItem(r,String(e)),0))}catch(e){return!1}}()&&y("REQUEST_INTERSTITIAL",{reason:"run_completed"}),O(n,t,!1)}function x(){c.reviveUsed?k(!1):(c.running=!1,c.awaitingRevive=!0,c.modalOpen=!0,o.reviveText.textContent="Continue from checkpoint with one revive.",o.reviveOverlay.classList.add("show"))}function w(e,t,n,a,i,l,r,o){return!(e+n<i||e>i+r||t+a<l||t>l+o)}function b(){const e=c.player;return{x:e.x-.5*e.w,y:e.y-.5*e.h,w:e.w,h:e.h}}function B(e,t,n){const a=b(),i=n[1],l=n[0],r=n[0]+n[2],o=a.y+a.h;return!(e.vy<0)&&(!(t>i+1)&&(!(o<i)&&!(a.x+a.w-4<l||a.x+4>r)))}function E(e,t,n){if("spike"===e.type)return w(n.x+3,n.y+6,n.w-6,n.h-6,e.x,e.y,e.w,e.h);if("roller"===e.type){const a=.5*(e.x1+e.x2),i=.5*(e.x2-e.x1),l=a+Math.sin(t*e.speed)*i,r=e.y,o=f(n.x+.5*n.w,l-e.r,l+e.r)-l,s=f(n.y+.5*n.h,r-e.r,r+e.r)-r;return o*o+s*s<e.r*e.r}if("dropper"===e.type){const a=.5*(Math.sin(t*e.speed)+1),i=e.yTop+(e.yBottom-e.yTop)*a;return w(n.x+4,n.y+4,n.w-8,n.h-8,e.x-.5*e.w,i,e.w,e.h)}if("flame"===e.type){return!!((t%e.cycle+e.cycle)%e.cycle<=e.cycle*e.duty)&&w(n.x+3,n.y+4,n.w-6,n.h-8,e.x,e.y,e.w,e.h)}return!1}function S(e){if(!c.running)return;c.elapsedMs+=1e3*e,o.time.textContent=(c.elapsedMs/1e3).toFixed(1);const t=c.player,n=m(),a=t.y+.5*t.h;let i=0;c.input.left&&(i-=1),c.input.right&&(i+=1),t.vx=240*i,0!==i&&(t.facing=i),c.input.jumpQueued&&t.onGround&&(t.vy=-720,t.onGround=!1),c.input.jumpQueued=!1,t.vy+=1850*e,t.x+=t.vx*e,t.y+=t.vy*e,t.x=f(t.x,10,n.length-10),t.onGround=!1;for(let e=0;e<n.surfaces.length;e++)if(B(t,a,n.surfaces[e])){t.y=n.surfaces[e][1]-.5*t.h,t.vy=0,t.onGround=!0;break}t.onGround&&t.x>c.checkpoint.x+220&&(c.checkpoint.x=t.x,c.checkpoint.y=t.y),c.invuln>0&&(c.invuln=Math.max(0,c.invuln-e));const l=b(),r=c.elapsedMs/1e3;if(c.invuln<=0)for(let e=0;e<n.hazards.length;e++)if(E(n.hazards[e],r,l))return void x();for(let e=0;e<n.leafStates.length;e++){const a=n.leafStates[e];if(a.taken)continue;const i=a.x-t.x,l=a.y-t.y;i*i+l*l<441&&(a.taken=!0,c.leavesTaken+=1)}t.y>920?x():(c.stageProgressScore=h(),o.score.textContent=String(c.stageProgressScore),c.cameraX=f(t.x-120,0,n.length-420),t.x>=n.length-74&&t.onGround&&(c.running=!1,c.modalOpen=!0,o.stageClearText.textContent=m().name+" cleared.",o.stageClearOverlay.classList.add("show")))}function I(e,t){const n=e[0]-t,a=e[1],i=e[2],l=e[3];s.fillStyle="#4f8d31",s.fillRect(n,a,i,l),s.fillStyle="#7dc652",s.fillRect(n+4,a+2,Math.max(8,i-8),Math.min(8,l-2))}function L(e,t,n){if("spike"===e.type){const t=e.x-n;s.fillStyle="#bf4032";for(let n=0;n<4;n++){const a=t+n*(e.w/4);s.beginPath(),s.moveTo(a,e.y+e.h),s.lineTo(a+e.w/8,e.y),s.lineTo(a+e.w/4,e.y+e.h),s.closePath(),s.fill()}return}if("roller"===e.type){const a=.5*(e.x1+e.x2),i=.5*(e.x2-e.x1),l=a+Math.sin(t*e.speed)*i-n;return s.fillStyle="#8f432e",s.beginPath(),s.arc(l,e.y,e.r,0,2*Math.PI),s.fill(),s.strokeStyle="#d27b5e",s.lineWidth=3,s.beginPath(),s.arc(l,e.y,e.r-4,0,2*Math.PI),void s.stroke()}if("dropper"===e.type){const a=.5*(Math.sin(t*e.speed)+1),i=e.yTop+(e.yBottom-e.yTop)*a,l=e.x-n;return s.fillStyle="#455265",s.fillRect(l-.5*e.w,i,e.w,e.h),s.fillStyle="#8190a2",void s.fillRect(l-.5*e.w+3,i+3,e.w-6,7)}if("flame"===e.type){const a=(t%e.cycle+e.cycle)%e.cycle<=e.cycle*e.duty,i=e.x-n;s.fillStyle="#704225",s.fillRect(i+4,e.y+e.h-10,e.w-8,10),a&&(s.fillStyle="#ff8f34",s.beginPath(),s.moveTo(i+.5*e.w,e.y-10),s.lineTo(i+e.w-2,e.y+e.h),s.lineTo(i+2,e.y+e.h),s.closePath(),s.fill())}}function R(e,t){e.taken||(s.save(),s.translate(e.x-t,e.y),s.fillStyle="#70c452",s.beginPath(),s.ellipse(0,0,11,8,-.35,0,2*Math.PI),s.fill(),s.strokeStyle="#3d7a28",s.lineWidth=2,s.beginPath(),s.moveTo(-7,3),s.lineTo(7,-2),s.stroke(),s.restore())}function T(){!function(){s.clearRect(0,0,420,760),s.fillStyle="rgba(255,255,255,0.24)";const e=.02*c.elapsedMs%120;for(let t=-2;t<8;t++){const n=120*t+e;s.beginPath(),s.ellipse(90,n,70,24,0,0,2*Math.PI),s.ellipse(260,n+30,86,28,0,0,2*Math.PI),s.fill()}}();const e=m(),t=c.cameraX,n=c.elapsedMs/1e3;for(let n=0;n<e.surfaces.length;n++)I(e.surfaces[n],t);for(let n=0;n<e.leafStates.length;n++)R(e.leafStates[n],t);for(let a=0;a<e.hazards.length;a++)L(e.hazards[a],n,t);!function(e,t){const n=e.length-64-t;s.fillStyle="#376a2b",s.fillRect(n,560,10,134),s.fillStyle="#f8f18c",s.beginPath(),s.moveTo(n+10,560),s.lineTo(n+56,578),s.lineTo(n+10,596),s.closePath(),s.fill()}(e,t),function(e){const t=c.player;s.save(),s.translate(t.x-e,t.y),c.invuln>0&&Math.floor(18*c.invuln)%2==0&&(s.globalAlpha=.5),s.scale(t.facing,1),s.fillStyle="#315f24",s.fillRect(-10,-20,20,28),s.fillStyle="#ffe4bf",s.beginPath(),s.arc(0,-24,10,0,2*Math.PI),s.fill(),s.fillStyle="#2f7f46",s.beginPath(),s.moveTo(-12,-32),s.lineTo(10,-38),s.lineTo(8,-17),s.lineTo(-10,-19),s.closePath(),s.fill(),s.restore()}(t)}async function M(){if(!c.db||!c.uid)return;const t=u(c.nick);if(!t)return;const n=c.db,a=c.uid,l=c.nick,r=c.nickKeyLower;await n.runTransaction(async function(i){const o=n.collection("games").doc(e).collection("nicknames").doc(t),s=await i.get(o);if(s.exists&&s.data().uid!==a)throw new Error("Nickname already used");if(i.set(o,{uid:a,nick:l,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),r&&r!==t){const t=n.collection("games").doc(e).collection("nicknames").doc(r),l=await i.get(t);l.exists&&l.data().uid===a&&i.delete(t)}}),c.nickKeyLower=t,localStorage.setItem(i,l)}async function O(t,a,i){if(!c.db||!c.uid)return;const l=c.db,r=c.uid;try{const o=l.collection("games").doc(e),s=o.collection("leaderboard").doc(r),d=o.collection("players").doc(r);await l.runTransaction(async function(e){const l=await e.get(o),u=l.exists&&l.data().sortDirection||n,y=await e.get(s),p=y.exists?Number(y.data().rankValue):null;if(!i&&(f=u,m=t,null!=(g=p)&&!("asc"===f?m<g:m>g)))return;var f,m,g;const v={uid:r,nick:c.nick,rankValue:t,rawValue:t,durationMs:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};e.set(s,v,{merge:!0}),e.set(d,{uid:r,nick:c.nick,bestRankValue:t,bestRawValue:t,durationMs:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}),await C()}catch(e){}}async function C(){if(!c.db)return o.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Offline</span><span>-</span></li>",void(o.myRank.textContent="My Rank: -");try{const t=c.db.collection("games").doc(e).collection("leaderboard"),n=await t.orderBy("rankValue","desc").limit(10).get(),a=[];let i=null,l=c.nick;if(n.forEach(function(e,t){const n=e.data()||{},r=t+1,o=1===r?"rank-1":2===r?"rank-2":3===r?"rank-3":"",s=n.nick||"Player",d=Number(n.rankValue||0);e.id===c.uid&&(i=d,l=s),a.push("<li class='lb-item'><span class='"+o+"'>"+r+"</span><span>"+(String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")+"</span><strong>")+d+"</strong></li>")}),o.lbList.innerHTML=a.length?a.join(""):"<li class='lb-item'><span>-</span><span>No scores yet</span><span>-</span></li>",c.uid){if(null===i){const e=await t.doc(c.uid).get();e.exists&&(i=Number((e.data()||{}).rankValue||0),l=(e.data()||{}).nick||l)}if(null===i)o.myRank.textContent="My Rank: Unranked";else{const e=(await t.where("rankValue",">",i).get()).size+1;o.myRank.textContent="My Rank: #"+e+" | "+l+" | "+i}}}catch(e){o.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Load failed</span><span>-</span></li>",o.myRank.textContent="My Rank: -"}}function A(){!c.startedSent&&c.running&&(c.startedSent=!0,y("GAME_START",{}))}function N(e,t){c.modalOpen||(A(),c.input[e]=t)}function P(){c.modalOpen||(A(),c.input.jumpQueued=!0)}function D(e,t){e.addEventListener("pointerdown",function(e){e.preventDefault(),N(t,!0)}),e.addEventListener("pointerup",function(e){e.preventDefault(),N(t,!1)}),e.addEventListener("pointercancel",function(){N(t,!1)}),e.addEventListener("pointerleave",function(){N(t,!1)})}function F(e){e&&"object"==typeof e&&("REWARDED_GRANTED"===e.type&&e.payload&&"revive"===e.payload.rewardType&&c.awaitingRevive&&(c.reviveUsed=!0,c.awaitingRevive=!1,c.modalOpen=!1,c.running=!0,c.player.x=c.checkpoint.x,c.player.y=c.checkpoint.y,c.player.vx=0,c.player.vy=0,c.player.onGround=!1,c.invuln=1.6,o.reviveOverlay.classList.remove("show")),"REWARDED_DENIED"===e.type&&c.awaitingRevive&&k(!1))}var V,G;d.forEach(function(e){e.leafStates=e.leaves.map(function(e){return{x:e[0],y:e[1],taken:!1}})}),o.score.textContent="0",o.stageLabel.textContent="1",window.addEventListener("keydown",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||N("left",!0),"ArrowRight"!==e.key&&"d"!==e.key||N("right",!0),"ArrowUp"!==e.key&&" "!==e.key&&"w"!==e.key||P()}),window.addEventListener("keyup",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||N("left",!1),"ArrowRight"!==e.key&&"d"!==e.key||N("right",!1)}),window.addEventListener("message",function(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}F(t)}),document.addEventListener("message",function(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}F(t)}),D(o.leftBtn,"left"),D(o.rightBtn,"right"),V=o.jumpBtn,G=P,V.addEventListener("pointerdown",function(e){e.preventDefault(),G()}),o.restartBtn.addEventListener("click",v),o.playAgainBtn.addEventListener("click",v),o.nextStageBtn.addEventListener("click",function(){const e=c.stageIndex+1;e>=d.length?k(!0):(o.stageClearOverlay.classList.remove("show"),c.modalOpen=!1,g(e,!1),c.running=!0)}),o.topBtn.addEventListener("click",function(){c.modalOpen=!0,o.leaderboardModal.classList.add("show"),c.latestSubmitted&&(o.latestRun.style.display="block",o.latestRun.textContent="Latest run: "+c.latestSubmitted.score+" points"),C()}),o.closeLbBtn.addEventListener("click",function(){o.leaderboardModal.classList.remove("show"),c.modalOpen=!1}),o.reviveBtn.addEventListener("click",function(){c.awaitingRevive&&(y("REQUEST_REWARDED",{reason:"revive"}),o.reviveText.textContent="Waiting for reward result...")}),o.skipReviveBtn.addEventListener("click",function(){k(!1)}),o.changeNickBtn.addEventListener("click",function(){o.nickInput.disabled=!1,o.nickInput.focus(),o.changeNickBtn.style.display="none",o.saveNickBtn.style.display="inline-block"}),o.saveNickBtn.addEventListener("click",async function(){const e=String(o.nickInput.value||"").trim().slice(0,20);if(!e)return;const t=c.nick,n=c.nickKeyLower;c.nick=e;try{await M(),o.nickInput.disabled=!0,o.changeNickBtn.style.display="inline-block",o.saveNickBtn.style.display="none",await C(),c.latestSubmitted&&await O(c.latestSubmitted.score,c.latestSubmitted.durationMs,!0)}catch(e){c.nick=t,c.nickKeyLower=n,o.nickInput.value=t,alert("Nickname already in use.")}}),document.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()}),v(),async function(){const l=window.FIREBASE_CONFIG||{apiKey:"<api-key>",authDomain:"<project-id>.firebaseapp.com",projectId:"<project-id>",appId:"<app-id>"};if(!Object.keys(l).some(function(e){return String(l[e]).indexOf("<")>=0}))try{firebase.initializeApp(l),c.db=firebase.firestore();const r=firebase.auth(),s=localStorage.getItem(i);c.nick=s&&s.trim()?s.trim():function(){const e="23456789";return"Leaf"+"ABCDEFGHJKLMNPQRSTUVWXYZ"[Math.floor(24*Math.random())]+e[Math.floor(8*Math.random())]+e[Math.floor(8*Math.random())]}(),localStorage.setItem(i,c.nick),c.nickKeyLower=u(c.nick),o.nickInput.value=c.nick,r.onAuthStateChanged(async function(i){if(i){c.uid=i.uid;try{await async function(){if(!c.db)return;const i=c.db.collection("games").doc(e);await i.set({sortDirection:n,rankType:a,version:t,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}(),await M(),await C()}catch(e){}}}),await r.signInAnonymously()}catch(e){}}(),requestAnimationFrame(function e(t){c.lastFrame||(c.lastFrame=t);const n=Math.min(.033,(t-c.lastFrame)/1e3);c.lastFrame=t,S(n),T(),requestAnimationFrame(e)})}()</script></body></html>