<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="game-id" content="leaf-lane-harvest"><meta name="game-version" content="0.3.3"><title>Leaf Lane Harvest</title><style>:root{--bg:#f7ecdd;--ink:#2f1c12;--panel:#fff6eb;--accent:#8a4f2f;--danger:#6e2418;--line:#d6b899;--gold:#cb9f28;--silver:#8897a6;--bronze:#9d6c48}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body,html{overscroll-behavior:none}body{margin:0;min-height:100vh;background:radial-gradient(circle at 30% 20%,#fff4e5 0,#f2dfc8 58%,#e2c8a8 100%);font-family:"Trebuchet MS","Segoe UI",sans-serif;color:var(--ink);display:flex;justify-content:center;overflow:hidden;touch-action:none;user-select:none}.app{width:min(100vw,520px);padding:10px;padding-top:calc(14px + env(safe-area-inset-top));padding-bottom:calc(18px + env(safe-area-inset-bottom))}.topbar{display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:8px;margin-bottom:8px}.pill{border:2px solid var(--line);border-radius:10px;background:#fffef5d9;text-align:center;font-weight:700;font-size:13px;padding:8px 6px}button{border:none;border-radius:10px;padding:9px 10px;font-weight:700;background:var(--accent);color:#fff;cursor:pointer}#stageWrap{position:relative;border:3px solid #7f9f57;border-radius:14px;overflow:hidden;background:linear-gradient(#8e5a3a,#6f4128);box-shadow:inset 0 -40px 120px rgba(34,16,9,.35);touch-action:none}canvas{width:100%;height:auto;display:block;touch-action:none}.hint{min-height:18px;text-align:center;margin-top:6px;font-size:13px;opacity:.9}.controls{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}.leftpad{display:grid;grid-template-columns:1fr 1fr;gap:8px}.btn-big{min-height:56px;font-size:18px;border:2px solid #5c311f;background:#a35e3a}.btn-jump{min-height:56px;font-size:18px;border:2px solid #5c311f;background:#7f4528}.modal,.overlay{position:fixed;inset:0;background:rgba(17,24,9,.58);display:none;align-items:center;justify-content:center;padding:14px;z-index:10}.modal.show,.overlay.show{display:flex}.panel{width:min(100%,460px);background:var(--panel);border-radius:14px;border:2px solid #dac892;padding:14px}.panel h2{margin:0 0 8px;font-size:21px}.row{display:flex;align-items:center;gap:8px}.row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}input[type=text]{flex:1;border:2px solid #d5c38e;border-radius:10px;padding:8px;font-size:14px;min-width:0}.lb-list{list-style:none;margin:10px 0;padding:0;border:1px solid #e8dbb4;border-radius:10px;max-height:280px;overflow:auto;background:#fffdf4}.lb-item{display:grid;grid-template-columns:34px 1fr auto;gap:8px;padding:7px 10px;border-bottom:1px solid #f2e8cc;font-size:14px}.lb-item:last-child{border-bottom:none}.rank-1{color:var(--gold);font-weight:800}.rank-2{color:var(--silver);font-weight:800}.rank-3{color:var(--bronze);font-weight:800}.my-rank{font-size:14px;background:#fff5d6;border:2px solid #efd290;border-radius:10px;padding:8px 10px}</style></head><body><div class="app"><div class="topbar"><div class="pill">Stage <span id="stageLabel">1</span>/5</div><div class="pill">Time <span id="time">0.0</span>s</div><div class="pill">Score <span id="score">0</span></div><button id="topBtn">Top</button> <button id="restartBtn">Restart</button></div><div id="stageWrap"><canvas id="stage" width="420" height="760" aria-label="game field"></canvas></div><div id="hint" class="hint">Mobile: hold left/right screen, tap center to jump. Eat chocolates.</div><div class="controls"><div class="leftpad"><button id="leftBtn" class="btn-big">◀</button> <button id="rightBtn" class="btn-big">▶</button></div><button id="jumpBtn" class="btn-jump">JUMP</button></div></div><div id="stageClearOverlay" class="overlay"><div class="panel"><h2>Stage Clear</h2><p id="stageClearText">Nice run.</p><div class="row"><button id="nextStageBtn">Next Stage</button></div></div></div><div id="reviveOverlay" class="overlay"><div class="panel"><h2>Revive once?</h2><p id="reviveText">Use rewarded ad in wrapper to continue.</p><div class="row"><button id="reviveBtn">Revive</button> <button id="skipReviveBtn" style="background:#8f322f">No Thanks</button></div></div></div><div id="gameOverOverlay" class="overlay"><div class="panel"><h2 id="resultTitle">Run Ended</h2><p>Score: <strong id="finalScore">0</strong></p><p>Duration: <strong id="finalTime">0.00s</strong></p><div class="row"><button id="playAgainBtn">Play Again</button></div></div></div><div id="leaderboardModal" class="modal"><div class="panel"><h2>Global Top 10</h2><div id="latestRun" class="my-rank" style="display:none;margin-bottom:8px"></div><div class="row"><input id="nickInput" maxlength="20" disabled="disabled"> <button id="changeNickBtn">Change</button> <button id="saveNickBtn" style="display:none">Save</button></div><ul id="lbList" class="lb-list"></ul><div id="myRank" class="my-rank">My Rank: -</div><div class="row-end"><button id="closeLbBtn">Close</button></div></div></div><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script><script>!function(){"use strict";const e="leaf-lane-harvest",t="0.3.3",n="desc",a="score",i=e+":nick",l=e+":best",o=e+":interstitial:last",r=420,s=760,c={milk:{label:"Milk",points:40,color:"#7d4b2e"},dark:{label:"Dark",points:70,color:"#4a2b1f"},ruby:{label:"Ruby",points:120,color:"#c6536a"},pistachio:{label:"Pistachio",points:180,color:"#6ca952"},dujjonku:{label:"Dujjonku",points:350,color:"#9b6d3f"}},d={stage:document.getElementById("stage"),stageLabel:document.getElementById("stageLabel"),time:document.getElementById("time"),score:document.getElementById("score"),hint:document.getElementById("hint"),topBtn:document.getElementById("topBtn"),restartBtn:document.getElementById("restartBtn"),leftBtn:document.getElementById("leftBtn"),rightBtn:document.getElementById("rightBtn"),jumpBtn:document.getElementById("jumpBtn"),stageClearOverlay:document.getElementById("stageClearOverlay"),stageClearText:document.getElementById("stageClearText"),nextStageBtn:document.getElementById("nextStageBtn"),reviveOverlay:document.getElementById("reviveOverlay"),reviveBtn:document.getElementById("reviveBtn"),skipReviveBtn:document.getElementById("skipReviveBtn"),reviveText:document.getElementById("reviveText"),gameOverOverlay:document.getElementById("gameOverOverlay"),resultTitle:document.getElementById("resultTitle"),finalScore:document.getElementById("finalScore"),finalTime:document.getElementById("finalTime"),playAgainBtn:document.getElementById("playAgainBtn"),leaderboardModal:document.getElementById("leaderboardModal"),lbList:document.getElementById("lbList"),myRank:document.getElementById("myRank"),latestRun:document.getElementById("latestRun"),nickInput:document.getElementById("nickInput"),changeNickBtn:document.getElementById("changeNickBtn"),saveNickBtn:document.getElementById("saveNickBtn"),closeLbBtn:document.getElementById("closeLbBtn")},u=d.stage.getContext("2d");const y={running:!1,modalOpen:!1,awaitingRevive:!1,reviveUsed:!1,startedSent:!1,elapsedMs:0,score:0,best:Number(localStorage.getItem(l)||0),stageIndex:0,cameraX:0,stageProgressScore:0,chocolatesEaten:0,chocolateScore:0,touchPointerId:null,input:{left:!1,right:!1,jumpQueued:!1},player:{x:80,y:620,w:30,h:40,vx:0,vy:0,onGround:!1,facing:1},checkpoint:{x:80,y:620},invuln:0,lastFrame:0,db:null,uid:null,nick:"",nickKeyLower:"",latestSubmitted:null},p=[{name:"Cocoa Gate",length:1700,surfaces:[[0,694,540,66],[610,694,350,66],[1040,694,300,66],[1410,694,290,66],[270,590,130,18],[500,550,120,18],[780,590,120,18],[1170,540,140,18]],hazards:[{type:"spike",x:560,y:674,w:48,h:20},{type:"roller",x1:700,x2:910,y:670,r:13,speed:1.4},{type:"flame",x:1230,y:644,w:24,h:50,cycle:1.8,duty:.6}],leaves:[[340,560],[560,520],[850,560],[1200,510],[1490,650]]},{name:"Ganache Run",length:1800,surfaces:[[0,694,360,66],[440,694,240,66],[760,694,210,66],[1060,694,260,66],[1380,694,420,66],[300,610,120,18],[670,575,110,18],[990,610,110,18],[1270,560,120,18]],hazards:[{type:"spike",x:380,y:674,w:52,h:20},{type:"dropper",x:705,yTop:430,yBottom:650,w:26,h:28,speed:1.7},{type:"roller",x1:1120,x2:1320,y:670,r:14,speed:1.8},{type:"flame",x:1500,y:644,w:24,h:50,cycle:1.5,duty:.56}],leaves:[[180,650],[500,650],[730,530],[1030,570],[1335,525],[1620,650]]},{name:"Nougat Steps",length:1900,surfaces:[[0,694,310,66],[360,650,180,18],[600,610,160,18],[820,570,150,18],[1020,530,140,18],[1220,570,140,18],[1440,620,170,18],[1680,694,220,66]],hazards:[{type:"spike",x:550,y:674,w:44,h:20},{type:"spike",x:970,y:674,w:44,h:20},{type:"dropper",x:1160,yTop:360,yBottom:610,w:24,h:30,speed:1.6},{type:"roller",x1:1500,x2:1680,y:596,r:12,speed:1.9}],leaves:[[250,650],[420,610],[650,570],[870,530],[1080,492],[1490,585],[1760,650]]},{name:"Truffle Bridge",length:2e3,surfaces:[[0,694,440,66],[520,640,170,18],[770,590,170,18],[1020,540,170,18],[1270,590,170,18],[1520,640,170,18],[1760,694,240,66]],hazards:[{type:"flame",x:480,y:644,w:24,h:50,cycle:1.7,duty:.5},{type:"roller",x1:820,x2:980,y:570,r:12,speed:2},{type:"dropper",x:1330,yTop:360,yBottom:610,w:24,h:32,speed:1.8},{type:"spike",x:1700,y:674,w:48,h:20}],leaves:[[230,650],[600,605],[850,555],[1100,505],[1370,555],[1600,605],[1870,650]]},{name:"Dujjonku Road",length:2200,surfaces:[[0,694,380,66],[460,694,280,66],[820,640,160,18],[1060,694,220,66],[1360,620,180,18],[1620,694,260,66],[1960,694,240,66]],hazards:[{type:"spike",x:400,y:674,w:44,h:20},{type:"roller",x1:840,x2:1020,y:620,r:13,speed:2.1},{type:"flame",x:1320,y:644,w:24,h:50,cycle:1.3,duty:.58},{type:"dropper",x:1750,yTop:360,yBottom:670,w:24,h:34,speed:2}],leaves:[[150,650],[540,650],[900,590],[1140,650],[1410,570],[1700,650],[2070,650]]}];function f(e){return String(e||"").trim().toLowerCase().replace(/\s+/g," ").slice(0,20)}function m(e,t){const n=JSON.stringify({type:e,payload:t||{}});window.ReactNativeWebView&&"function"==typeof window.ReactNativeWebView.postMessage&&window.ReactNativeWebView.postMessage(n)}function g(e){return(e/1e3).toFixed(2)+"s"}function h(e,t,n){return Math.max(t,Math.min(n,e))}function v(e,t,n,a){const i=function(e,t,n){if(t===n-1)return"dujjonku";const a=["milk","dark","ruby","pistachio"];return a[(e+t)%a.length]}(t,n,a),l=c[i];return{x:e[0],y:e[1],type:i,points:l.points,taken:!1}}function k(){return p[y.stageIndex]}function w(e,t){y.stageIndex=e;const n=k();t||(y.checkpoint.x=80,y.checkpoint.y=620),y.player.x=t?y.checkpoint.x:80,y.player.y=t?y.checkpoint.y:620,y.player.vx=0,y.player.vy=0,y.player.onGround=!1,y.cameraX=0,d.stageLabel.textContent=String(e+1),n.leafStates=n.leaves.map(function(t,a){return v(t,e,a,n.leaves.length)})}function x(){y.running=!0,y.modalOpen=!1,y.awaitingRevive=!1,y.reviveUsed=!1,y.startedSent=!1,y.elapsedMs=0,y.score=0,y.stageProgressScore=0,y.chocolatesEaten=0,y.chocolateScore=0,y.invuln=0,y.lastFrame=0,w(0,!1),d.score.textContent="0",d.time.textContent="0.0",d.hint.textContent="Mobile: hold left/right screen, tap center to jump. Eat chocolates.",d.stageClearOverlay.classList.remove("show"),d.reviveOverlay.classList.remove("show"),d.gameOverOverlay.classList.remove("show"),d.latestRun.style.display="none";for(let e=0;e<p.length;e++)p[e].leafStates=p[e].leaves.map(function(t,n){return v(t,e,n,p[e].leaves.length)})}function b(){return 700*y.stageIndex+y.chocolateScore}function S(e){y.running=!1,y.awaitingRevive=!1,y.modalOpen=!1,d.stageClearOverlay.classList.remove("show"),d.reviveOverlay.classList.remove("show"),d.gameOverOverlay.classList.add("show");const t=Math.max(1,Math.round(y.elapsedMs));let n=b();e?(n+=2200,d.resultTitle.textContent="All Stages Cleared"):d.resultTitle.textContent="Run Ended",y.score=n,y.latestSubmitted={score:n,durationMs:t},d.finalScore.textContent=String(n),d.finalTime.textContent=g(t),d.latestRun.style.display="block",d.latestRun.textContent="Latest run: "+n+" points in "+g(t),n>y.best&&(y.best=n,localStorage.setItem(l,String(n))),m("GAME_OVER",{score:n,durationMs:t}),function(){try{const e=Date.now(),t=Number(localStorage.getItem(o)||0);return!(t&&e-t<35e3||(localStorage.setItem(o,String(e)),0))}catch(e){return!1}}()&&m("REQUEST_INTERSTITIAL",{reason:"run_completed"}),A(n,t,!1)}function B(){y.reviveUsed?S(!1):(y.running=!1,y.awaitingRevive=!0,y.modalOpen=!0,d.reviveText.textContent="Continue from checkpoint with one revive.",d.reviveOverlay.classList.add("show"))}function E(e,t,n,a,i,l,o,r){return!(e+n<i||e>i+o||t+a<l||t>l+r)}function I(){const e=y.player;return{x:e.x-.5*e.w,y:e.y-.5*e.h,w:e.w,h:e.h}}function L(e,t,n){const a=I(),i=n[1],l=n[0],o=n[0]+n[2],r=a.y+a.h;return!(e.vy<0)&&(!(t>i+1)&&(!(r<i)&&!(a.x+a.w-4<l||a.x+4>o)))}function R(e,t,n){if("spike"===e.type)return E(n.x+3,n.y+6,n.w-6,n.h-6,e.x,e.y,e.w,e.h);if("roller"===e.type){const a=.5*(e.x1+e.x2),i=.5*(e.x2-e.x1),l=a+Math.sin(t*e.speed)*i,o=e.y,r=h(n.x+.5*n.w,l-e.r,l+e.r)-l,s=h(n.y+.5*n.h,o-e.r,o+e.r)-o;return r*r+s*s<e.r*e.r}if("dropper"===e.type){const a=.5*(Math.sin(t*e.speed)+1),i=e.yTop+(e.yBottom-e.yTop)*a;return E(n.x+4,n.y+4,n.w-8,n.h-8,e.x-.5*e.w,i,e.w,e.h)}if("flame"===e.type){return!!((t%e.cycle+e.cycle)%e.cycle<=e.cycle*e.duty)&&E(n.x+3,n.y+4,n.w-6,n.h-8,e.x,e.y,e.w,e.h)}return!1}function M(e){if(!y.running)return;y.elapsedMs+=1e3*e,d.time.textContent=(y.elapsedMs/1e3).toFixed(1);const t=y.player,n=k(),a=t.y+.5*t.h;let i=0;y.input.left&&(i-=1),y.input.right&&(i+=1),t.vx=240*i,0!==i&&(t.facing=i),y.input.jumpQueued&&t.onGround&&(t.vy=-720,t.onGround=!1),y.input.jumpQueued=!1,t.vy+=1850*e,t.x+=t.vx*e,t.y+=t.vy*e,t.x=h(t.x,10,n.length-10),t.onGround=!1;for(let e=0;e<n.surfaces.length;e++)if(L(t,a,n.surfaces[e])){t.y=n.surfaces[e][1]-.5*t.h,t.vy=0,t.onGround=!0;break}t.onGround&&t.x>y.checkpoint.x+220&&(y.checkpoint.x=t.x,y.checkpoint.y=t.y),y.invuln>0&&(y.invuln=Math.max(0,y.invuln-e));const l=I(),o=y.elapsedMs/1e3;if(y.invuln<=0)for(let e=0;e<n.hazards.length;e++)if(R(n.hazards[e],o,l))return void B();for(let e=0;e<n.leafStates.length;e++){const a=n.leafStates[e];if(a.taken)continue;a.x,t.x,a.y,t.y;E(l.x-8,l.y-8,l.w+16,l.h+16,a.x-14,a.y-14,28,28)&&(a.taken=!0,y.chocolatesEaten+=1,y.chocolateScore+=a.points)}t.y>920?B():(y.stageProgressScore=b(),d.score.textContent=String(y.stageProgressScore),y.cameraX=h(t.x-120,0,n.length-r),t.x>=n.length-74&&t.onGround&&(y.running=!1,y.modalOpen=!0,d.stageClearText.textContent=k().name+" cleared. Choco score +"+y.chocolateScore+".",d.stageClearOverlay.classList.add("show")))}function T(e,t){const n=e[0]-t,a=e[1],i=e[2],l=e[3];u.fillStyle="#5b331f",u.fillRect(n,a,i,l),u.fillStyle="#8b5435",u.fillRect(n+4,a+2,Math.max(8,i-8),Math.min(8,l-2)),u.strokeStyle="#c2855a",u.lineWidth=2;for(let e=n+10;e<n+i-10;e+=18)u.beginPath(),u.moveTo(e,a+3),u.lineTo(e+7,a+Math.min(l-3,11)),u.stroke()}function P(e,t,n){if("spike"===e.type){const t=e.x-n;u.fillStyle="#3a2417";for(let n=0;n<4;n++){const a=t+n*(e.w/4);u.beginPath(),u.moveTo(a,e.y+e.h),u.lineTo(a+e.w/8,e.y),u.lineTo(a+e.w/4,e.y+e.h),u.closePath(),u.fill()}return u.fillStyle="#e8b07d",void u.fillRect(t+3,e.y+e.h-5,e.w-6,3)}if("roller"===e.type){const a=.5*(e.x1+e.x2),i=.5*(e.x2-e.x1),l=a+Math.sin(t*e.speed)*i-n;return u.fillStyle="#412316",u.beginPath(),u.arc(l,e.y,e.r,0,2*Math.PI),u.fill(),u.strokeStyle="#dfb084",u.lineWidth=3,u.beginPath(),u.arc(l,e.y,e.r-4,0,2*Math.PI),u.stroke(),u.fillStyle="#7f4f34",u.beginPath(),u.arc(l+2,e.y-2,2.4,0,2*Math.PI),void u.fill()}if("dropper"===e.type){const a=.5*(Math.sin(t*e.speed)+1),i=e.yTop+(e.yBottom-e.yTop)*a,l=e.x-n;return u.fillStyle="#301d13",u.fillRect(l-.5*e.w,i,e.w,e.h),u.fillStyle="#7f553d",u.fillRect(l-.5*e.w+3,i+3,e.w-6,7),u.fillStyle="#d7a373",u.beginPath(),u.arc(l,i+e.h+4,6,0,2*Math.PI),void u.fill()}if("flame"===e.type){const a=(t%e.cycle+e.cycle)%e.cycle<=e.cycle*e.duty,i=e.x-n;u.fillStyle="#4f2f1e",u.fillRect(i+4,e.y+e.h-10,e.w-8,10),a&&(u.fillStyle="#e5a048",u.beginPath(),u.moveTo(i+.5*e.w,e.y-10),u.lineTo(i+e.w-2,e.y+e.h),u.lineTo(i+2,e.y+e.h),u.closePath(),u.fill(),u.fillStyle="#ffd08f",u.beginPath(),u.arc(i+.5*e.w,e.y+6,5,0,2*Math.PI),u.fill())}}function C(e,t){if(e.taken)return;u.save(),u.translate(e.x-t,e.y);const n=c[e.type]||c.milk;u.fillStyle=n.color,u.beginPath(),u.ellipse(0,0,12,9,-.15,0,2*Math.PI),u.fill(),"dujjonku"===e.type&&(u.strokeStyle="#f4d8a8",u.lineWidth=2,u.beginPath(),u.arc(0,0,5,0,2*Math.PI),u.stroke()),u.strokeStyle="#2f241f",u.lineWidth=2,u.beginPath(),u.moveTo(-6,2),u.lineTo(6,-2),u.stroke(),u.restore()}function O(){!function(){u.clearRect(0,0,r,s);const e=u.createLinearGradient(0,0,0,s);e.addColorStop(0,"#9f6a46"),e.addColorStop(.5,"#7f4c30"),e.addColorStop(1,"#63361f"),u.fillStyle=e,u.fillRect(0,0,r,s),u.fillStyle="rgba(255, 240, 215, 0.2)";const t=.015*y.elapsedMs%150;for(let e=-2;e<7;e++){const n=150*e+t;u.beginPath(),u.ellipse(100,n,90,30,0,0,2*Math.PI),u.ellipse(285,n+35,110,34,0,0,2*Math.PI),u.fill()}u.fillStyle="rgba(240, 210, 170, 0.22)";for(let e=0;e<24;e++){const t=(77*e+.02*y.elapsedMs)%460-20,n=53*e%s;u.beginPath(),u.arc(t,n,2.2,0,2*Math.PI),u.fill()}}();const e=k(),t=y.cameraX,n=y.elapsedMs/1e3;for(let n=0;n<e.surfaces.length;n++)T(e.surfaces[n],t);for(let n=0;n<e.leafStates.length;n++)C(e.leafStates[n],t);for(let a=0;a<e.hazards.length;a++)P(e.hazards[a],n,t);!function(e,t){const n=e.length-64-t;u.fillStyle="#c08b4f",u.fillRect(n,560,10,134),u.fillStyle="#ffe8b5",u.beginPath(),u.moveTo(n+10,560),u.lineTo(n+56,578),u.lineTo(n+10,596),u.closePath(),u.fill(),u.fillStyle="#563121",u.fillRect(n-12,620,62,44),u.fillStyle="#d5a06f",u.fillRect(n-8,624,54,10)}(e,t),function(e){const t=y.player;u.save(),u.translate(t.x-e,t.y),y.invuln>0&&Math.floor(18*y.invuln)%2==0&&(u.globalAlpha=.5),u.scale(t.facing,1),u.fillStyle="#3a2417",u.fillRect(-10,-20,20,28),u.fillStyle="#ffe3c1",u.beginPath(),u.arc(0,-24,10,0,2*Math.PI),u.fill(),u.fillStyle="#a9623d",u.beginPath(),u.moveTo(-12,-32),u.lineTo(10,-38),u.lineTo(8,-17),u.lineTo(-10,-19),u.closePath(),u.fill(),u.fillStyle="#7b3f26",u.fillRect(-4,10,8,7),u.restore()}(t)}async function N(){if(!y.db||!y.uid)return;const t=f(y.nick);if(!t)return;const n=y.db,a=y.uid,l=y.nick,o=y.nickKeyLower;await n.runTransaction(async function(i){const r=n.collection("games").doc(e).collection("nicknames").doc(t),s=await i.get(r);if(s.exists&&s.data().uid!==a)throw new Error("Nickname already used");if(i.set(r,{uid:a,nick:l,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),o&&o!==t){const t=n.collection("games").doc(e).collection("nicknames").doc(o),l=await i.get(t);l.exists&&l.data().uid===a&&i.delete(t)}}),y.nickKeyLower=t,localStorage.setItem(i,l)}async function A(t,a,i){if(!y.db||!y.uid)return;const l=y.db,o=y.uid;try{const r=l.collection("games").doc(e),s=r.collection("leaderboard").doc(o),c=r.collection("players").doc(o);await l.runTransaction(async function(e){const l=await e.get(r),d=l.exists&&l.data().sortDirection||n,u=await e.get(s),p=u.exists?Number(u.data().rankValue):null;if(!i&&(f=d,m=t,null!=(g=p)&&!("asc"===f?m<g:m>g)))return;var f,m,g;const h={uid:o,nick:y.nick,rankValue:t,rawValue:t,durationMs:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};e.set(s,h,{merge:!0}),e.set(c,{uid:o,nick:y.nick,bestRankValue:t,bestRawValue:t,durationMs:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}),await D()}catch(e){}}async function D(){if(!y.db)return d.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Offline</span><span>-</span></li>",void(d.myRank.textContent="My Rank: -");try{const t=y.db.collection("games").doc(e).collection("leaderboard"),n=await t.orderBy("rankValue","desc").limit(10).get(),a=[];let i=null,l=y.nick;if(n.forEach(function(e,t){const n=e.data()||{},o=t+1,r=1===o?"rank-1":2===o?"rank-2":3===o?"rank-3":"",s=n.nick||"Player",c=Number(n.rankValue||0);e.id===y.uid&&(i=c,l=s),a.push("<li class='lb-item'><span class='"+r+"'>"+o+"</span><span>"+(String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")+"</span><strong>")+c+"</strong></li>")}),d.lbList.innerHTML=a.length?a.join(""):"<li class='lb-item'><span>-</span><span>No scores yet</span><span>-</span></li>",y.uid){if(null===i){const e=await t.doc(y.uid).get();e.exists&&(i=Number((e.data()||{}).rankValue||0),l=(e.data()||{}).nick||l)}if(null===i)d.myRank.textContent="My Rank: Unranked";else{const e=(await t.where("rankValue",">",i).get()).size+1;d.myRank.textContent="My Rank: #"+e+" | "+l+" | "+i}}}catch(e){d.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Load failed</span><span>-</span></li>",d.myRank.textContent="My Rank: -"}}function j(){!y.startedSent&&y.running&&(y.startedSent=!0,m("GAME_START",{}))}function V(e,t){y.modalOpen||(j(),y.input[e]=t)}function F(){y.modalOpen||(j(),y.input.jumpQueued=!0)}function G(e,t){e.addEventListener("pointerdown",function(e){e.preventDefault(),V(t,!0)}),e.addEventListener("pointerup",function(e){e.preventDefault(),V(t,!1)}),e.addEventListener("pointercancel",function(){V(t,!1)}),e.addEventListener("pointerleave",function(){V(t,!1)})}function W(e,t){const n=d.stage.getBoundingClientRect(),a=e-n.left,i=n.width/3;if("up"===t)return y.input.left=!1,void(y.input.right=!1);a<i?(y.input.left=!0,y.input.right=!1):a>2*i?(y.input.left=!1,y.input.right=!0):(y.input.left=!1,y.input.right=!1,F())}function z(e){e&&"object"==typeof e&&("REWARDED_GRANTED"===e.type&&e.payload&&"revive"===e.payload.rewardType&&y.awaitingRevive&&(y.reviveUsed=!0,y.awaitingRevive=!1,y.modalOpen=!1,y.running=!0,y.player.x=y.checkpoint.x,y.player.y=y.checkpoint.y,y.player.vx=0,y.player.vy=0,y.player.onGround=!1,y.invuln=1.6,d.reviveOverlay.classList.remove("show")),"REWARDED_DENIED"===e.type&&y.awaitingRevive&&S(!1))}var U,K;d.score.textContent="0",d.stageLabel.textContent="1",window.addEventListener("keydown",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||V("left",!0),"ArrowRight"!==e.key&&"d"!==e.key||V("right",!0),"ArrowUp"!==e.key&&" "!==e.key&&"w"!==e.key||F()}),window.addEventListener("keyup",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||V("left",!1),"ArrowRight"!==e.key&&"d"!==e.key||V("right",!1)}),window.addEventListener("message",function(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}z(t)}),document.addEventListener("message",function(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}z(t)}),G(d.leftBtn,"left"),G(d.rightBtn,"right"),U=d.jumpBtn,K=F,U.addEventListener("pointerdown",function(e){e.preventDefault(),K()}),d.stage.addEventListener("pointerdown",function(e){e.preventDefault(),y.touchPointerId=e.pointerId,W(e.clientX,"down")}),d.stage.addEventListener("pointermove",function(e){y.touchPointerId===e.pointerId&&(e.preventDefault(),W(e.clientX,"move"))}),d.stage.addEventListener("pointerup",function(e){y.touchPointerId===e.pointerId&&(e.preventDefault(),y.touchPointerId=null,W(e.clientX,"up"))}),d.stage.addEventListener("pointercancel",function(){y.touchPointerId=null,y.input.left=!1,y.input.right=!1}),d.restartBtn.addEventListener("click",x),d.playAgainBtn.addEventListener("click",x),d.nextStageBtn.addEventListener("click",function(){const e=y.stageIndex+1;e>=p.length?S(!0):(d.stageClearOverlay.classList.remove("show"),y.modalOpen=!1,w(e,!1),y.running=!0)}),d.topBtn.addEventListener("click",function(){y.modalOpen=!0,d.leaderboardModal.classList.add("show"),y.latestSubmitted&&(d.latestRun.style.display="block",d.latestRun.textContent="Latest run: "+y.latestSubmitted.score+" points"),D()}),d.closeLbBtn.addEventListener("click",function(){d.leaderboardModal.classList.remove("show"),y.modalOpen=!1}),d.reviveBtn.addEventListener("click",function(){y.awaitingRevive&&(m("REQUEST_REWARDED",{reason:"revive"}),d.reviveText.textContent="Waiting for reward result...")}),d.skipReviveBtn.addEventListener("click",function(){S(!1)}),d.changeNickBtn.addEventListener("click",function(){d.nickInput.disabled=!1,d.nickInput.focus(),d.changeNickBtn.style.display="none",d.saveNickBtn.style.display="inline-block"}),d.saveNickBtn.addEventListener("click",async function(){const e=String(d.nickInput.value||"").trim().slice(0,20);if(!e)return;const t=y.nick,n=y.nickKeyLower;y.nick=e;try{await N(),d.nickInput.disabled=!0,d.changeNickBtn.style.display="inline-block",d.saveNickBtn.style.display="none",await D(),y.latestSubmitted&&await A(y.latestSubmitted.score,y.latestSubmitted.durationMs,!0)}catch(e){y.nick=t,y.nickKeyLower=n,d.nickInput.value=t,alert("Nickname already in use.")}}),document.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()}),x(),async function(){const l=window.FIREBASE_CONFIG||{apiKey:"<api-key>",authDomain:"<project-id>.firebaseapp.com",projectId:"<project-id>",appId:"<app-id>"};if(!Object.keys(l).some(function(e){return String(l[e]).indexOf("<")>=0}))try{firebase.initializeApp(l),y.db=firebase.firestore();const o=firebase.auth(),r=localStorage.getItem(i);y.nick=r&&r.trim()?r.trim():function(){const e="23456789";return"Leaf"+"ABCDEFGHJKLMNPQRSTUVWXYZ"[Math.floor(24*Math.random())]+e[Math.floor(8*Math.random())]+e[Math.floor(8*Math.random())]}(),localStorage.setItem(i,y.nick),y.nickKeyLower=f(y.nick),d.nickInput.value=y.nick,o.onAuthStateChanged(async function(i){if(i){y.uid=i.uid;try{await async function(){if(!y.db)return;const i=y.db.collection("games").doc(e);await i.set({sortDirection:n,rankType:a,version:t,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}(),await N(),await D()}catch(e){}}}),await o.signInAnonymously()}catch(e){}}(),requestAnimationFrame(function e(t){y.lastFrame||(y.lastFrame=t);const n=Math.min(.033,(t-y.lastFrame)/1e3);y.lastFrame=t,M(n),O(),requestAnimationFrame(e)})}()</script></body></html>