<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="game-id" content="leaf-lane-harvest"><meta name="game-version" content="0.3.1"><title>Leaf Lane Harvest</title><style>:root{--bg:#e7f3d1;--ink:#1f2d19;--panel:#fff9e8;--accent:#2e8a4f;--danger:#9f3530;--line:#b7d08b;--gold:#cb9f28;--silver:#8897a6;--bronze:#9d6c48}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body,html{overscroll-behavior:none}body{margin:0;min-height:100vh;background:radial-gradient(circle at 30% 20%,#f7ffe7 0,#e9f3d3 58%,#dce9be 100%);font-family:"Trebuchet MS","Segoe UI",sans-serif;color:var(--ink);display:flex;justify-content:center;overflow:hidden;touch-action:none;user-select:none}.app{width:min(100vw,520px);padding:10px;padding-top:calc(14px + env(safe-area-inset-top));padding-bottom:calc(18px + env(safe-area-inset-bottom))}.topbar{display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:8px;margin-bottom:8px}.pill{border:2px solid var(--line);border-radius:10px;background:#fffef5d9;text-align:center;font-weight:700;font-size:13px;padding:8px 6px}button{border:none;border-radius:10px;padding:9px 10px;font-weight:700;background:var(--accent);color:#fff;cursor:pointer}#stageWrap{position:relative;border:3px solid #7f9f57;border-radius:14px;overflow:hidden;background:linear-gradient(#9cd370,#7dbc59);box-shadow:inset 0 -40px 120px rgba(33,52,16,.25);touch-action:none}canvas{width:100%;height:auto;display:block;touch-action:none}.hint{min-height:18px;text-align:center;margin-top:6px;font-size:13px;opacity:.9}.controls{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}.leftpad{display:grid;grid-template-columns:1fr 1fr;gap:8px}.btn-big{min-height:56px;font-size:18px;border:2px solid #245f38;background:#3da460}.btn-jump{min-height:56px;font-size:18px;border:2px solid #245f38;background:#2f7f46}.modal,.overlay{position:fixed;inset:0;background:rgba(17,24,9,.58);display:none;align-items:center;justify-content:center;padding:14px;z-index:10}.modal.show,.overlay.show{display:flex}.panel{width:min(100%,460px);background:var(--panel);border-radius:14px;border:2px solid #dac892;padding:14px}.panel h2{margin:0 0 8px;font-size:21px}.row{display:flex;align-items:center;gap:8px}.row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}input[type=text]{flex:1;border:2px solid #d5c38e;border-radius:10px;padding:8px;font-size:14px;min-width:0}.lb-list{list-style:none;margin:10px 0;padding:0;border:1px solid #e8dbb4;border-radius:10px;max-height:280px;overflow:auto;background:#fffdf4}.lb-item{display:grid;grid-template-columns:34px 1fr auto;gap:8px;padding:7px 10px;border-bottom:1px solid #f2e8cc;font-size:14px}.lb-item:last-child{border-bottom:none}.rank-1{color:var(--gold);font-weight:800}.rank-2{color:var(--silver);font-weight:800}.rank-3{color:var(--bronze);font-weight:800}.my-rank{font-size:14px;background:#fff5d6;border:2px solid #efd290;border-radius:10px;padding:8px 10px}</style></head><body><div class="app"><div class="topbar"><div class="pill">Stage <span id="stageLabel">1</span>/5</div><div class="pill">Time <span id="time">0.0</span>s</div><div class="pill">Score <span id="score">0</span></div><button id="topBtn">Top</button> <button id="restartBtn">Restart</button></div><div id="stageWrap"><canvas id="stage" width="420" height="760" aria-label="game field"></canvas></div><div id="hint" class="hint">Move + Jump, eat chocolates. Dujjonku is highest score.</div><div class="controls"><div class="leftpad"><button id="leftBtn" class="btn-big">◀</button> <button id="rightBtn" class="btn-big">▶</button></div><button id="jumpBtn" class="btn-jump">JUMP</button></div></div><div id="stageClearOverlay" class="overlay"><div class="panel"><h2>Stage Clear</h2><p id="stageClearText">Nice run.</p><div class="row"><button id="nextStageBtn">Next Stage</button></div></div></div><div id="reviveOverlay" class="overlay"><div class="panel"><h2>Revive once?</h2><p id="reviveText">Use rewarded ad in wrapper to continue.</p><div class="row"><button id="reviveBtn">Revive</button> <button id="skipReviveBtn" style="background:#8f322f">No Thanks</button></div></div></div><div id="gameOverOverlay" class="overlay"><div class="panel"><h2 id="resultTitle">Run Ended</h2><p>Score: <strong id="finalScore">0</strong></p><p>Duration: <strong id="finalTime">0.00s</strong></p><div class="row"><button id="playAgainBtn">Play Again</button></div></div></div><div id="leaderboardModal" class="modal"><div class="panel"><h2>Global Top 10</h2><div id="latestRun" class="my-rank" style="display:none;margin-bottom:8px"></div><div class="row"><input id="nickInput" maxlength="20" disabled="disabled"> <button id="changeNickBtn">Change</button> <button id="saveNickBtn" style="display:none">Save</button></div><ul id="lbList" class="lb-list"></ul><div id="myRank" class="my-rank">My Rank: -</div><div class="row-end"><button id="closeLbBtn">Close</button></div></div></div><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script><script>!function(){"use strict";const e="leaf-lane-harvest",t="0.3.1",n="desc",a="score",i=e+":nick",o=e+":best",l=e+":interstitial:last",r={milk:{label:"Milk",points:40,color:"#7d4b2e"},dark:{label:"Dark",points:70,color:"#4a2b1f"},ruby:{label:"Ruby",points:120,color:"#c6536a"},pistachio:{label:"Pistachio",points:180,color:"#6ca952"},dujjonku:{label:"Dujjonku",points:350,color:"#9b6d3f"}},s={stage:document.getElementById("stage"),stageLabel:document.getElementById("stageLabel"),time:document.getElementById("time"),score:document.getElementById("score"),hint:document.getElementById("hint"),topBtn:document.getElementById("topBtn"),restartBtn:document.getElementById("restartBtn"),leftBtn:document.getElementById("leftBtn"),rightBtn:document.getElementById("rightBtn"),jumpBtn:document.getElementById("jumpBtn"),stageClearOverlay:document.getElementById("stageClearOverlay"),stageClearText:document.getElementById("stageClearText"),nextStageBtn:document.getElementById("nextStageBtn"),reviveOverlay:document.getElementById("reviveOverlay"),reviveBtn:document.getElementById("reviveBtn"),skipReviveBtn:document.getElementById("skipReviveBtn"),reviveText:document.getElementById("reviveText"),gameOverOverlay:document.getElementById("gameOverOverlay"),resultTitle:document.getElementById("resultTitle"),finalScore:document.getElementById("finalScore"),finalTime:document.getElementById("finalTime"),playAgainBtn:document.getElementById("playAgainBtn"),leaderboardModal:document.getElementById("leaderboardModal"),lbList:document.getElementById("lbList"),myRank:document.getElementById("myRank"),latestRun:document.getElementById("latestRun"),nickInput:document.getElementById("nickInput"),changeNickBtn:document.getElementById("changeNickBtn"),saveNickBtn:document.getElementById("saveNickBtn"),closeLbBtn:document.getElementById("closeLbBtn")},c=s.stage.getContext("2d");const d={running:!1,modalOpen:!1,awaitingRevive:!1,reviveUsed:!1,startedSent:!1,elapsedMs:0,score:0,best:Number(localStorage.getItem(o)||0),stageIndex:0,cameraX:0,stageProgressScore:0,chocolatesEaten:0,chocolateScore:0,input:{left:!1,right:!1,jumpQueued:!1},player:{x:80,y:620,w:30,h:40,vx:0,vy:0,onGround:!1,facing:1},checkpoint:{x:80,y:620},invuln:0,lastFrame:0,db:null,uid:null,nick:"",nickKeyLower:"",latestSubmitted:null},u=[{name:"Garden Gate",length:1700,surfaces:[[0,694,540,66],[610,694,350,66],[1040,694,300,66],[1410,694,290,66],[270,590,130,18],[500,550,120,18],[780,590,120,18],[1170,540,140,18]],hazards:[{type:"spike",x:560,y:674,w:48,h:20},{type:"roller",x1:700,x2:910,y:670,r:13,speed:1.4},{type:"flame",x:1230,y:644,w:24,h:50,cycle:1.8,duty:.6}],leaves:[[340,560],[560,520],[850,560],[1200,510],[1490,650]]},{name:"Fence Run",length:1800,surfaces:[[0,694,360,66],[440,694,240,66],[760,694,210,66],[1060,694,260,66],[1380,694,420,66],[300,610,120,18],[670,575,110,18],[990,610,110,18],[1270,560,120,18]],hazards:[{type:"spike",x:380,y:674,w:52,h:20},{type:"dropper",x:705,yTop:430,yBottom:650,w:26,h:28,speed:1.7},{type:"roller",x1:1120,x2:1320,y:670,r:14,speed:1.8},{type:"flame",x:1500,y:644,w:24,h:50,cycle:1.5,duty:.56}],leaves:[[180,650],[500,650],[730,530],[1030,570],[1335,525],[1620,650]]},{name:"Stone Steps",length:1900,surfaces:[[0,694,310,66],[360,650,180,18],[600,610,160,18],[820,570,150,18],[1020,530,140,18],[1220,570,140,18],[1440,620,170,18],[1680,694,220,66]],hazards:[{type:"spike",x:550,y:674,w:44,h:20},{type:"spike",x:970,y:674,w:44,h:20},{type:"dropper",x:1160,yTop:360,yBottom:610,w:24,h:30,speed:1.6},{type:"roller",x1:1500,x2:1680,y:596,r:12,speed:1.9}],leaves:[[250,650],[420,610],[650,570],[870,530],[1080,492],[1490,585],[1760,650]]},{name:"Ivy Bridge",length:2e3,surfaces:[[0,694,440,66],[520,640,170,18],[770,590,170,18],[1020,540,170,18],[1270,590,170,18],[1520,640,170,18],[1760,694,240,66]],hazards:[{type:"flame",x:480,y:644,w:24,h:50,cycle:1.7,duty:.5},{type:"roller",x1:820,x2:980,y:570,r:12,speed:2},{type:"dropper",x:1330,yTop:360,yBottom:610,w:24,h:32,speed:1.8},{type:"spike",x:1700,y:674,w:48,h:20}],leaves:[[230,650],[600,605],[850,555],[1100,505],[1370,555],[1600,605],[1870,650]]},{name:"Harvest Road",length:2200,surfaces:[[0,694,380,66],[460,694,280,66],[820,640,160,18],[1060,694,220,66],[1360,620,180,18],[1620,694,260,66],[1960,694,240,66]],hazards:[{type:"spike",x:400,y:674,w:44,h:20},{type:"roller",x1:840,x2:1020,y:620,r:13,speed:2.1},{type:"flame",x:1320,y:644,w:24,h:50,cycle:1.3,duty:.58},{type:"dropper",x:1750,yTop:360,yBottom:670,w:24,h:34,speed:2}],leaves:[[150,650],[540,650],[900,590],[1140,650],[1410,570],[1700,650],[2070,650]]}];function y(e){return String(e||"").trim().toLowerCase().replace(/\s+/g," ").slice(0,20)}function p(e,t){const n=JSON.stringify({type:e,payload:t||{}});window.ReactNativeWebView&&"function"==typeof window.ReactNativeWebView.postMessage&&window.ReactNativeWebView.postMessage(n)}function f(e){return(e/1e3).toFixed(2)+"s"}function m(e,t,n){return Math.max(t,Math.min(n,e))}function g(e,t,n,a){const i=function(e,t,n){if(t===n-1)return"dujjonku";const a=["milk","dark","ruby","pistachio"];return a[(e+t)%a.length]}(t,n,a),o=r[i];return{x:e[0],y:e[1],type:i,points:o.points,taken:!1}}function h(){return u[d.stageIndex]}function v(e,t){d.stageIndex=e;const n=h();t||(d.checkpoint.x=80,d.checkpoint.y=620),d.player.x=t?d.checkpoint.x:80,d.player.y=t?d.checkpoint.y:620,d.player.vx=0,d.player.vy=0,d.player.onGround=!1,d.cameraX=0,s.stageLabel.textContent=String(e+1),n.leafStates=n.leaves.map(function(t,a){return g(t,e,a,n.leaves.length)})}function k(){d.running=!0,d.modalOpen=!1,d.awaitingRevive=!1,d.reviveUsed=!1,d.startedSent=!1,d.elapsedMs=0,d.score=0,d.stageProgressScore=0,d.chocolatesEaten=0,d.chocolateScore=0,d.invuln=0,d.lastFrame=0,v(0,!1),s.score.textContent="0",s.time.textContent="0.0",s.hint.textContent="Move + Jump, eat chocolates. Dujjonku is highest score.",s.stageClearOverlay.classList.remove("show"),s.reviveOverlay.classList.remove("show"),s.gameOverOverlay.classList.remove("show"),s.latestRun.style.display="none";for(let e=0;e<u.length;e++)u[e].leafStates=u[e].leaves.map(function(t,n){return g(t,e,n,u[e].leaves.length)})}function x(){return 700*d.stageIndex+d.chocolateScore}function w(e){d.running=!1,d.awaitingRevive=!1,d.modalOpen=!1,s.stageClearOverlay.classList.remove("show"),s.reviveOverlay.classList.remove("show"),s.gameOverOverlay.classList.add("show");const t=Math.max(1,Math.round(d.elapsedMs));let n=x();e?(n+=2200,s.resultTitle.textContent="All Stages Cleared"):s.resultTitle.textContent="Run Ended",d.score=n,d.latestSubmitted={score:n,durationMs:t},s.finalScore.textContent=String(n),s.finalTime.textContent=f(t),s.latestRun.style.display="block",s.latestRun.textContent="Latest run: "+n+" points in "+f(t),n>d.best&&(d.best=n,localStorage.setItem(o,String(n))),p("GAME_OVER",{score:n,durationMs:t}),function(){try{const e=Date.now(),t=Number(localStorage.getItem(l)||0);return!(t&&e-t<35e3||(localStorage.setItem(l,String(e)),0))}catch(e){return!1}}()&&p("REQUEST_INTERSTITIAL",{reason:"run_completed"}),A(n,t,!1)}function b(){d.reviveUsed?w(!1):(d.running=!1,d.awaitingRevive=!0,d.modalOpen=!0,s.reviveText.textContent="Continue from checkpoint with one revive.",s.reviveOverlay.classList.add("show"))}function B(e,t,n,a,i,o,l,r){return!(e+n<i||e>i+l||t+a<o||t>o+r)}function S(){const e=d.player;return{x:e.x-.5*e.w,y:e.y-.5*e.h,w:e.w,h:e.h}}function E(e,t,n){const a=S(),i=n[1],o=n[0],l=n[0]+n[2],r=a.y+a.h;return!(e.vy<0)&&(!(t>i+1)&&(!(r<i)&&!(a.x+a.w-4<o||a.x+4>l)))}function I(e,t,n){if("spike"===e.type)return B(n.x+3,n.y+6,n.w-6,n.h-6,e.x,e.y,e.w,e.h);if("roller"===e.type){const a=.5*(e.x1+e.x2),i=.5*(e.x2-e.x1),o=a+Math.sin(t*e.speed)*i,l=e.y,r=m(n.x+.5*n.w,o-e.r,o+e.r)-o,s=m(n.y+.5*n.h,l-e.r,l+e.r)-l;return r*r+s*s<e.r*e.r}if("dropper"===e.type){const a=.5*(Math.sin(t*e.speed)+1),i=e.yTop+(e.yBottom-e.yTop)*a;return B(n.x+4,n.y+4,n.w-8,n.h-8,e.x-.5*e.w,i,e.w,e.h)}if("flame"===e.type){return!!((t%e.cycle+e.cycle)%e.cycle<=e.cycle*e.duty)&&B(n.x+3,n.y+4,n.w-6,n.h-8,e.x,e.y,e.w,e.h)}return!1}function L(e){if(!d.running)return;d.elapsedMs+=1e3*e,s.time.textContent=(d.elapsedMs/1e3).toFixed(1);const t=d.player,n=h(),a=t.y+.5*t.h;let i=0;d.input.left&&(i-=1),d.input.right&&(i+=1),t.vx=240*i,0!==i&&(t.facing=i),d.input.jumpQueued&&t.onGround&&(t.vy=-720,t.onGround=!1),d.input.jumpQueued=!1,t.vy+=1850*e,t.x+=t.vx*e,t.y+=t.vy*e,t.x=m(t.x,10,n.length-10),t.onGround=!1;for(let e=0;e<n.surfaces.length;e++)if(E(t,a,n.surfaces[e])){t.y=n.surfaces[e][1]-.5*t.h,t.vy=0,t.onGround=!0;break}t.onGround&&t.x>d.checkpoint.x+220&&(d.checkpoint.x=t.x,d.checkpoint.y=t.y),d.invuln>0&&(d.invuln=Math.max(0,d.invuln-e));const o=S(),l=d.elapsedMs/1e3;if(d.invuln<=0)for(let e=0;e<n.hazards.length;e++)if(I(n.hazards[e],l,o))return void b();for(let e=0;e<n.leafStates.length;e++){const a=n.leafStates[e];if(a.taken)continue;const i=a.x-t.x,o=a.y-t.y;i*i+o*o<441&&(a.taken=!0,d.chocolatesEaten+=1,d.chocolateScore+=a.points)}t.y>920?b():(d.stageProgressScore=x(),s.score.textContent=String(d.stageProgressScore),d.cameraX=m(t.x-120,0,n.length-420),t.x>=n.length-74&&t.onGround&&(d.running=!1,d.modalOpen=!0,s.stageClearText.textContent=h().name+" cleared. Choco score +"+d.chocolateScore+".",s.stageClearOverlay.classList.add("show")))}function R(e,t){const n=e[0]-t,a=e[1],i=e[2],o=e[3];c.fillStyle="#4f8d31",c.fillRect(n,a,i,o),c.fillStyle="#7dc652",c.fillRect(n+4,a+2,Math.max(8,i-8),Math.min(8,o-2))}function M(e,t,n){if("spike"===e.type){const t=e.x-n;c.fillStyle="#bf4032";for(let n=0;n<4;n++){const a=t+n*(e.w/4);c.beginPath(),c.moveTo(a,e.y+e.h),c.lineTo(a+e.w/8,e.y),c.lineTo(a+e.w/4,e.y+e.h),c.closePath(),c.fill()}return}if("roller"===e.type){const a=.5*(e.x1+e.x2),i=.5*(e.x2-e.x1),o=a+Math.sin(t*e.speed)*i-n;return c.fillStyle="#8f432e",c.beginPath(),c.arc(o,e.y,e.r,0,2*Math.PI),c.fill(),c.strokeStyle="#d27b5e",c.lineWidth=3,c.beginPath(),c.arc(o,e.y,e.r-4,0,2*Math.PI),void c.stroke()}if("dropper"===e.type){const a=.5*(Math.sin(t*e.speed)+1),i=e.yTop+(e.yBottom-e.yTop)*a,o=e.x-n;return c.fillStyle="#455265",c.fillRect(o-.5*e.w,i,e.w,e.h),c.fillStyle="#8190a2",void c.fillRect(o-.5*e.w+3,i+3,e.w-6,7)}if("flame"===e.type){const a=(t%e.cycle+e.cycle)%e.cycle<=e.cycle*e.duty,i=e.x-n;c.fillStyle="#704225",c.fillRect(i+4,e.y+e.h-10,e.w-8,10),a&&(c.fillStyle="#ff8f34",c.beginPath(),c.moveTo(i+.5*e.w,e.y-10),c.lineTo(i+e.w-2,e.y+e.h),c.lineTo(i+2,e.y+e.h),c.closePath(),c.fill())}}function T(e,t){if(e.taken)return;c.save(),c.translate(e.x-t,e.y);const n=r[e.type]||r.milk;c.fillStyle=n.color,c.beginPath(),c.ellipse(0,0,12,9,-.15,0,2*Math.PI),c.fill(),"dujjonku"===e.type&&(c.strokeStyle="#f4d8a8",c.lineWidth=2,c.beginPath(),c.arc(0,0,5,0,2*Math.PI),c.stroke()),c.strokeStyle="#2f241f",c.lineWidth=2,c.beginPath(),c.moveTo(-6,2),c.lineTo(6,-2),c.stroke(),c.restore()}function O(){!function(){c.clearRect(0,0,420,760),c.fillStyle="rgba(255,255,255,0.24)";const e=.02*d.elapsedMs%120;for(let t=-2;t<8;t++){const n=120*t+e;c.beginPath(),c.ellipse(90,n,70,24,0,0,2*Math.PI),c.ellipse(260,n+30,86,28,0,0,2*Math.PI),c.fill()}}();const e=h(),t=d.cameraX,n=d.elapsedMs/1e3;for(let n=0;n<e.surfaces.length;n++)R(e.surfaces[n],t);for(let n=0;n<e.leafStates.length;n++)T(e.leafStates[n],t);for(let a=0;a<e.hazards.length;a++)M(e.hazards[a],n,t);!function(e,t){const n=e.length-64-t;c.fillStyle="#376a2b",c.fillRect(n,560,10,134),c.fillStyle="#f8f18c",c.beginPath(),c.moveTo(n+10,560),c.lineTo(n+56,578),c.lineTo(n+10,596),c.closePath(),c.fill()}(e,t),function(e){const t=d.player;c.save(),c.translate(t.x-e,t.y),d.invuln>0&&Math.floor(18*d.invuln)%2==0&&(c.globalAlpha=.5),c.scale(t.facing,1),c.fillStyle="#315f24",c.fillRect(-10,-20,20,28),c.fillStyle="#ffe4bf",c.beginPath(),c.arc(0,-24,10,0,2*Math.PI),c.fill(),c.fillStyle="#2f7f46",c.beginPath(),c.moveTo(-12,-32),c.lineTo(10,-38),c.lineTo(8,-17),c.lineTo(-10,-19),c.closePath(),c.fill(),c.restore()}(t)}async function C(){if(!d.db||!d.uid)return;const t=y(d.nick);if(!t)return;const n=d.db,a=d.uid,o=d.nick,l=d.nickKeyLower;await n.runTransaction(async function(i){const r=n.collection("games").doc(e).collection("nicknames").doc(t),s=await i.get(r);if(s.exists&&s.data().uid!==a)throw new Error("Nickname already used");if(i.set(r,{uid:a,nick:o,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),l&&l!==t){const t=n.collection("games").doc(e).collection("nicknames").doc(l),o=await i.get(t);o.exists&&o.data().uid===a&&i.delete(t)}}),d.nickKeyLower=t,localStorage.setItem(i,o)}async function A(t,a,i){if(!d.db||!d.uid)return;const o=d.db,l=d.uid;try{const r=o.collection("games").doc(e),s=r.collection("leaderboard").doc(l),c=r.collection("players").doc(l);await o.runTransaction(async function(e){const o=await e.get(r),u=o.exists&&o.data().sortDirection||n,y=await e.get(s),p=y.exists?Number(y.data().rankValue):null;if(!i&&(f=u,m=t,null!=(g=p)&&!("asc"===f?m<g:m>g)))return;var f,m,g;const h={uid:l,nick:d.nick,rankValue:t,rawValue:t,durationMs:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};e.set(s,h,{merge:!0}),e.set(c,{uid:l,nick:d.nick,bestRankValue:t,bestRawValue:t,durationMs:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}),await N()}catch(e){}}async function N(){if(!d.db)return s.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Offline</span><span>-</span></li>",void(s.myRank.textContent="My Rank: -");try{const t=d.db.collection("games").doc(e).collection("leaderboard"),n=await t.orderBy("rankValue","desc").limit(10).get(),a=[];let i=null,o=d.nick;if(n.forEach(function(e,t){const n=e.data()||{},l=t+1,r=1===l?"rank-1":2===l?"rank-2":3===l?"rank-3":"",s=n.nick||"Player",c=Number(n.rankValue||0);e.id===d.uid&&(i=c,o=s),a.push("<li class='lb-item'><span class='"+r+"'>"+l+"</span><span>"+(String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")+"</span><strong>")+c+"</strong></li>")}),s.lbList.innerHTML=a.length?a.join(""):"<li class='lb-item'><span>-</span><span>No scores yet</span><span>-</span></li>",d.uid){if(null===i){const e=await t.doc(d.uid).get();e.exists&&(i=Number((e.data()||{}).rankValue||0),o=(e.data()||{}).nick||o)}if(null===i)s.myRank.textContent="My Rank: Unranked";else{const e=(await t.where("rankValue",">",i).get()).size+1;s.myRank.textContent="My Rank: #"+e+" | "+o+" | "+i}}}catch(e){s.lbList.innerHTML="<li class='lb-item'><span>-</span><span>Load failed</span><span>-</span></li>",s.myRank.textContent="My Rank: -"}}function P(){!d.startedSent&&d.running&&(d.startedSent=!0,p("GAME_START",{}))}function j(e,t){d.modalOpen||(P(),d.input[e]=t)}function D(){d.modalOpen||(P(),d.input.jumpQueued=!0)}function F(e,t){e.addEventListener("pointerdown",function(e){e.preventDefault(),j(t,!0)}),e.addEventListener("pointerup",function(e){e.preventDefault(),j(t,!1)}),e.addEventListener("pointercancel",function(){j(t,!1)}),e.addEventListener("pointerleave",function(){j(t,!1)})}function V(e){e&&"object"==typeof e&&("REWARDED_GRANTED"===e.type&&e.payload&&"revive"===e.payload.rewardType&&d.awaitingRevive&&(d.reviveUsed=!0,d.awaitingRevive=!1,d.modalOpen=!1,d.running=!0,d.player.x=d.checkpoint.x,d.player.y=d.checkpoint.y,d.player.vx=0,d.player.vy=0,d.player.onGround=!1,d.invuln=1.6,s.reviveOverlay.classList.remove("show")),"REWARDED_DENIED"===e.type&&d.awaitingRevive&&w(!1))}var G,z;s.score.textContent="0",s.stageLabel.textContent="1",window.addEventListener("keydown",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||j("left",!0),"ArrowRight"!==e.key&&"d"!==e.key||j("right",!0),"ArrowUp"!==e.key&&" "!==e.key&&"w"!==e.key||D()}),window.addEventListener("keyup",function(e){"ArrowLeft"!==e.key&&"a"!==e.key||j("left",!1),"ArrowRight"!==e.key&&"d"!==e.key||j("right",!1)}),window.addEventListener("message",function(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}V(t)}),document.addEventListener("message",function(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}V(t)}),F(s.leftBtn,"left"),F(s.rightBtn,"right"),G=s.jumpBtn,z=D,G.addEventListener("pointerdown",function(e){e.preventDefault(),z()}),s.restartBtn.addEventListener("click",k),s.playAgainBtn.addEventListener("click",k),s.nextStageBtn.addEventListener("click",function(){const e=d.stageIndex+1;e>=u.length?w(!0):(s.stageClearOverlay.classList.remove("show"),d.modalOpen=!1,v(e,!1),d.running=!0)}),s.topBtn.addEventListener("click",function(){d.modalOpen=!0,s.leaderboardModal.classList.add("show"),d.latestSubmitted&&(s.latestRun.style.display="block",s.latestRun.textContent="Latest run: "+d.latestSubmitted.score+" points"),N()}),s.closeLbBtn.addEventListener("click",function(){s.leaderboardModal.classList.remove("show"),d.modalOpen=!1}),s.reviveBtn.addEventListener("click",function(){d.awaitingRevive&&(p("REQUEST_REWARDED",{reason:"revive"}),s.reviveText.textContent="Waiting for reward result...")}),s.skipReviveBtn.addEventListener("click",function(){w(!1)}),s.changeNickBtn.addEventListener("click",function(){s.nickInput.disabled=!1,s.nickInput.focus(),s.changeNickBtn.style.display="none",s.saveNickBtn.style.display="inline-block"}),s.saveNickBtn.addEventListener("click",async function(){const e=String(s.nickInput.value||"").trim().slice(0,20);if(!e)return;const t=d.nick,n=d.nickKeyLower;d.nick=e;try{await C(),s.nickInput.disabled=!0,s.changeNickBtn.style.display="inline-block",s.saveNickBtn.style.display="none",await N(),d.latestSubmitted&&await A(d.latestSubmitted.score,d.latestSubmitted.durationMs,!0)}catch(e){d.nick=t,d.nickKeyLower=n,s.nickInput.value=t,alert("Nickname already in use.")}}),document.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()}),k(),async function(){const o=window.FIREBASE_CONFIG||{apiKey:"<api-key>",authDomain:"<project-id>.firebaseapp.com",projectId:"<project-id>",appId:"<app-id>"};if(!Object.keys(o).some(function(e){return String(o[e]).indexOf("<")>=0}))try{firebase.initializeApp(o),d.db=firebase.firestore();const l=firebase.auth(),r=localStorage.getItem(i);d.nick=r&&r.trim()?r.trim():function(){const e="23456789";return"Leaf"+"ABCDEFGHJKLMNPQRSTUVWXYZ"[Math.floor(24*Math.random())]+e[Math.floor(8*Math.random())]+e[Math.floor(8*Math.random())]}(),localStorage.setItem(i,d.nick),d.nickKeyLower=y(d.nick),s.nickInput.value=d.nick,l.onAuthStateChanged(async function(i){if(i){d.uid=i.uid;try{await async function(){if(!d.db)return;const i=d.db.collection("games").doc(e);await i.set({sortDirection:n,rankType:a,version:t,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0})}(),await C(),await N()}catch(e){}}}),await l.signInAnonymously()}catch(e){}}(),requestAnimationFrame(function e(t){d.lastFrame||(d.lastFrame=t);const n=Math.min(.033,(t-d.lastFrame)/1e3);d.lastFrame=t,L(n),O(),requestAnimationFrame(e)})}()</script></body></html>